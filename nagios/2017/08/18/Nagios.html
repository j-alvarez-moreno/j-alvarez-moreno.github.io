<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title></title>
	
	<meta name="author" content="Josué Álvarez Moreno">

	<!-- Enable responsive viewport -->
	<meta name="viewport" content="width=device-width, initial-scale=1.0">

	<!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
	<!--[if lt IE 9]>
	<script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
	<![endif]-->

	<!-- Le styles -->
	<link href="/assets/resources/bootstrap/css/bootstrap.min.css" rel="stylesheet">
	<link href="/assets/resources/font-awesome/css/font-awesome.min.css" rel="stylesheet">
	<link href="/assets/resources/syntax/syntax.css" rel="stylesheet">
	<link href="/assets/css/style.css" rel="stylesheet">

	<!-- Le fav and touch icons -->
	<!-- Update these with your own images
	<link rel="shortcut icon" href="images/favicon.ico">
	<link rel="apple-touch-icon" href="images/apple-touch-icon.png">
	<link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
	<link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
	-->

</head>

<body>
	<nav class="navbar navbar-default visible-xs" role="navigation">
		<!-- Brand and toggle get grouped for better mobile display -->
		<div class="navbar-header">
			<button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
				<span class="sr-only">Toggle navigation</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			
			<a type="button" class="navbar-toggle nav-link" href="http://github.com/j-alvarez-moreno">
				<i class="fa fa-github"></i>
			</a>
			
			
			<a type="button" class="navbar-toggle nav-link" href="mailto:blog@josuealvarezmoreno.com">
				<i class="fa fa-envelope"></i>
			</a>
			
			
			<a type="button" class="navbar-toggle nav-link" href="https://linkedin.com/in/josué-álvarez-moreno-b88896144">
				<i class="fa fa-linkedin fa-lg"></i>
			</a>
			
			<a type="button" class="navbar-toggle nav-link"  data-toggle="collapse" data-target="#language-picker">
				<i class="fa fa-globe"></i>
				<span class="sr-only">Language selection.</span>
			</a>
			<a class="navbar-brand" href="/">
				<img src="//www.gravatar.com/avatar/da3470a132e93bfe23072dccad7e2956?s=35" class="img-circle" />
				
			</a>
		</div>
		<div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
			<ul class="nav navbar-nav">
				<li class="active"><a href="/">Home</a></li>
				<li><a href="/categories.html">Categories</a></li>
				<li><a href="/tags.html">Tags</a></li>
			</ul>
		</div><!-- /.navbar-collapse -->
		<div class="collapse navbar-collapse" id="language-picker">
			<ul class="nav navbar-nav">
				
					<li><a 
							style="font-size: 16px; color: grey"
						 href=" /es/nagios/2017/08/18/Nagios.html ">Español</a></li>
	  			
					<li><a 
							style="font-weight: bold; font-size: 20px; color: #ffcb6a"
						 href=" /nagios/2017/08/18/Nagios.html ">English</a></li>
	  			
			</ul>
		</div>
	</nav>

	<!-- nav-menu-dropdown -->
	<div class="btn-group hidden-xs" id="nav-menu">
		<button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
			<i class="fa fa-bars"></i>
		</button>
		<ul class="dropdown-menu" role="menu">
			<li><a href="/"><i class="fa fa-home"></i>Home</a></li>
			<li><a href="/categories.html"><i class="fa fa-folder"></i>Categories</a></li>
			<li><a href="/tags.html"><i class="fa fa-tags"></i>Tags</a></li>
			<li class="divider"></li>
			<li><a href="#"><i class="fa fa-arrow-up"></i>Top of Page</a></li>
		</ul>
	</div>

	<div class="col-sm-3 sidebar hidden-xs" style="">
		<!-- sidebar.html -->
<header class="sidebar-header" role="banner">
	<a href="/">
		<img src="//www.gravatar.com/avatar/da3470a132e93bfe23072dccad7e2956?s=150" class="img-circle" />
	</a>
	<h3 class="title">
        <a href="/"></a>
    </h3>
</header>


<div id="bio" class="text-center">
	
</div>


<div id="contact-list" class="text-center">
	<ul class="list-unstyled list-inline">
		
		<li>
			<a class="btn btn-default btn-sm" href="https://github.com/j-alvarez-moreno">
				<i class="fa fa-github-alt fa-lg"></i>
			</a>
		</li>
		
		
		
		<li>
			<a class="btn btn-default btn-sm" href="mailto:blog@josuealvarezmoreno.com">
				<i class="fa fa-envelope fa-lg"></i>
			</a>
		</li>
		
		<li>
			<a class="btn btn-default btn-sm" href="https://linkedin.com/in/josué-álvarez-moreno-b88896144">
				<i class="fa fa-linkedin fa-lg"></i>
			</a>
		</li>
	</ul>
	<br><br><br><br>
	<div id="language-switcher">
  		
			<a 
					style="font-size: 16px; color: white"
				 href=" /es/nagios/2017/08/18/Nagios.html ">Español</a>
			 | 
  		
			<a 
					style="font-weight: bold; font-size: 20px; color: #ffcb6a"
				 href=" /nagios/2017/08/18/Nagios.html ">English</a>
			
  		
  	</div>
</div>
<!-- sidebar.html end -->

	</div>

	<div class="col-sm-9 col-sm-offset-3">
		<div class="page-header">
  <h1>Monitoring our infrastructure with Nagios. </h1>
</div>
	
<article>

	<div class="col-sm-10">
	 <span class="post-date">
	   
	   August 
	   18th,
	   
	   2017
	 </span>    ·      
	 <span class="reading-time" title="Estimated read time">
 	

	
	
	Estimated time to read:  15 minutes.
  
</span>

	  <div class="article_body">
	  <p>In this post we will learn how to monitor computers and services with Nagios. This will allow us to receive timely and actionable alerts about issues in our infrastructure.</p>

<ul id="markdown-toc">
  <li><a href="#what-is-nagios" id="markdown-toc-what-is-nagios">What is Nagios.</a></li>
  <li><a href="#nagios-how-it-works" id="markdown-toc-nagios-how-it-works">Nagios: How it works.</a>    <ul>
      <li><a href="#monitored-service-states-and-transition-flow-between-states" id="markdown-toc-monitored-service-states-and-transition-flow-between-states">Monitored service states, and transition flow between states.</a>        <ul>
          <li><a href="#a-resource-is-flapping-what-does-flapping-mean" id="markdown-toc-a-resource-is-flapping-what-does-flapping-mean">A resource is “flapping”. What does “flapping” mean?</a></li>
        </ul>
      </li>
    </ul>
  </li>
  <li><a href="#description-of-the-scenario-we-are-working-with-in-this-post" id="markdown-toc-description-of-the-scenario-we-are-working-with-in-this-post">Description of the scenario we are working with in this post.</a></li>
  <li><a href="#installing-nagios" id="markdown-toc-installing-nagios">Installing Nagios.</a></li>
  <li><a href="#monitoring-services-and-computers" id="markdown-toc-monitoring-services-and-computers">Monitoring services and computers.</a>    <ul>
      <li><a href="#installing-the-monitoring-agent" id="markdown-toc-installing-the-monitoring-agent">Installing the monitoring agent.</a></li>
      <li><a href="#adding-devices-to-the-monitoring-list" id="markdown-toc-adding-devices-to-the-monitoring-list">Adding devices to the monitoring list</a></li>
      <li><a href="#defining-services-to-monitor" id="markdown-toc-defining-services-to-monitor">Defining services to monitor</a></li>
      <li><a href="#adding-custom-service-checks" id="markdown-toc-adding-custom-service-checks">Adding custom service checks.</a>        <ul>
          <li><a href="#checking-for-zombie-processes" id="markdown-toc-checking-for-zombie-processes">Checking for zombie processes.</a>            <ul>
              <li><a href="#nagios-server" id="markdown-toc-nagios-server">Nagios server</a></li>
              <li><a href="#monitored-device" id="markdown-toc-monitored-device">Monitored device.</a></li>
            </ul>
          </li>
        </ul>
      </li>
      <li><a href="#installing-additional-plugins-to-monitor-other-services" id="markdown-toc-installing-additional-plugins-to-monitor-other-services">Installing additional plugins to monitor other services.</a>        <ul>
          <li><a href="#installing-nagios-plugin-mongodb" id="markdown-toc-installing-nagios-plugin-mongodb">Installing nagios-plugin-mongodb</a></li>
        </ul>
      </li>
      <li><a href="#setting-up-email-notifications" id="markdown-toc-setting-up-email-notifications">Setting up email notifications</a>        <ul>
          <li><a href="#customizing-the-email-contents-and-the-sending-methods" id="markdown-toc-customizing-the-email-contents-and-the-sending-methods">Customizing the email contents and the sending methods.</a></li>
        </ul>
      </li>
    </ul>
  </li>
  <li><a href="#at-a-glance-overview-of-our-devices-and-services" id="markdown-toc-at-a-glance-overview-of-our-devices-and-services">At-a-glance overview of our devices and services.</a></li>
  <li><a href="#testing-notifications" id="markdown-toc-testing-notifications">Testing notifications.</a>    <ul>
      <li><a href="#device-offline" id="markdown-toc-device-offline">Device offline.</a></li>
      <li><a href="#zombie-process" id="markdown-toc-zombie-process">Zombie process.</a></li>
      <li><a href="#mongodb-server-availability" id="markdown-toc-mongodb-server-availability">MongoDB server availability.</a></li>
    </ul>
  </li>
  <li><a href="#closing-thoughts" id="markdown-toc-closing-thoughts">Closing thoughts.</a></li>
</ul>

<h1 id="what-is-nagios">What is Nagios.</h1>
<p>Nagios is an application that monitors computers, services, networks and infrastructure. It sends alerts in case of trouble, and it sends notifications when the issue is resolved.</p>

<p>Unlike other commercial alternatives like SolarWinds, Nagios is both free and Open Source and <a href="https://support.nagios.com/support-plans/">it also offers the option of purchasing a support plan</a>.</p>

<h1 id="nagios-how-it-works">Nagios: How it works.</h1>

<p>Nagios can obtain information about the monitored resources in two different ways:</p>

<ul>
  <li>
    <p>Using the Nagios Agent: After deploying the Agent to the computers you want to monitor, these agents collect the information and perform the checks by themselves before sending them to the Nagios server.
  -The main advantage of this method is the flexbility it offers, since we can define custom checks and write code to monitor any resource we can think of. The disadvantage would be that we have to push the definition of these custom checks to the clients.</p>
  </li>
  <li>
    <p><em>Agentless</em> : The Nagios server uses the facilities provided by the device that is being monitored (for example, VMI or SNMP).</p>
    <ul>
      <li>The main advantage of this mode is that it reduces the complexity of our deployment, and it allows us to centralize all the configuration in the Nagios server. The disadvantage would be that it does not allow for custom checks, so if the device does not provide a facility for monitoring a resource we can’t monitor it this way.</li>
    </ul>
  </li>
</ul>

<p>Nagios is able to use both modes at the same time, combining the results from agent checks and from agentless checks.
<!--more--></p>

<h2 id="monitored-service-states-and-transition-flow-between-states">Monitored service states, and transition flow between states.</h2>

<p>The state of a resource is determined through two components:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>- The state of the service or resource: OK, WARNING, UP, DOWN...
- The type of state the resource is in: soft or hard.
</code></pre>
</div>

<p>To prevent false positives caused by temporary circumstances, Nagios will perform the check a number of times before considering a problem to be “happening”. This number of retries is defined by the <em>max_check_attempts</em> variable, and if the limit is reached Nagios will change the issue from <em>soft</em> to <em>hard</em>. This also works in reverse, before marking an issue as <em>solved</em> the check is repeated this same number of times.</p>

<p>Unless we specify otherwise, notifications are only set when a resource is <em>hard down</em>.</p>

<p>We can write our own handler for these events to perfom custom actions depending on the resource state. For example, if the web server is <em>soft down</em> and the check has been retried 3 times already, we can trigger the deployment of a secondary instance of the web server and add it to the load balancer in anticipation of the main web server going down.</p>

<p><a href="https://assets.nagios.com/downloads/nagioscore/docs/nagioscore/3/en/statetypes.html">An in-depth description of the states is available in the manual</a>.</p>

<h3 id="a-resource-is-flapping-what-does-flapping-mean">A resource is “flapping”. What does “flapping” mean?</h3>

<p>When a resource is rapidly and repeatedly transitioning between <em>OK</em> and a state that means an issue is happening, the resource is tagged as <em>flapping</em>. This could indicate a deeper issue, or be caused by perfectly normal conditions, for example we know for sure that the database becomes unresponsive at a certain time of the day because of heavy load, and we know it does not affect regular operations.</p>

<p>In any case, flapping would generate many notifications about the same issue. In order to mitigate this situation, we should increase <em>max_check_attempts</em> to a value that allows these false positives to fall under the threshold and be careful to not increase too much that issues go unreported.</p>

<p>Nagios contains logic that tries to address flapping, but given the nature of the problem it might not be enough to eliminate the problem in our specific environment.</p>

<h1 id="description-of-the-scenario-we-are-working-with-in-this-post">Description of the scenario we are working with in this post.</h1>

<p>We have three virtual machines in the same network, all three using Debian 8 (Jessie).</p>

<ul>
  <li>nagiosHost: 192.168.100.1, will function as the Nagios server. It will also host a MongoDB instance, and an SSH server.</li>
  <li>servidorLamp: 192.168.100.2, will have a LAMP stack installed.</li>
  <li>escritorioUsuario: 192.168.100.3, will be a desktop for the end-user to use.</li>
</ul>

<p>This scenario can be deployed automatically through the use of this <a href="/assets/vagrantfiles/2017-08-18-Nagios/en/Vagrantfile.zip">Vagrantfile</a>, including all services and configuration.</p>

<h1 id="installing-nagios">Installing Nagios.</h1>

<figure class="highlight"><pre><code class="language-none" data-lang="none">sudo DEBIAN_FRONTEND=noninteractive apt-get -y install nagios-plugins nagios3 nagios-nrpe-plugin</code></pre></figure>

<p><em>nrpe-server</em> is the name of the Agent software that is installed in the monitored machines, and will send status reports back to the Nagios server as well as executing remote checks. As we have explained at the beginning, these checks can be customized by the administrator, and <em>nagios-plugins</em> is a package that contains many useful pre-defined checks. Later on we’ll explain how to install additional components that will enable us to monitor a MongoDB database and how to create our own custom checks to, for example, check for the existence of zombie processes.</p>

<p>To be able to run checks on-demand, we have to make the following change on <em>/etc/nagios3/nagios.cfg</em></p>

<figure class="highlight"><pre><code class="language-none" data-lang="none">check_external_commands = 1</code></pre></figure>

<p>We must also change the owner and mode of these two directories, so the nagios service is able to write temporary files to them. If we were to not do this, we would get error messages along the lines of <em>Could not stat() command file ‘/var/lib/nagios3/rw/nagios.cmd’</em>.</p>

<p>We will implement these changes at the package manager level, to preserve them in case of updates.</p>

<figure class="highlight"><pre><code class="language-none" data-lang="none">dpkg-statoverride --update --add nagios www-data 2710 /var/lib/nagios3/rw
sudo dpkg-statoverride --update --add nagios nagios 751 /var/lib/nagios3</code></pre></figure>

<p>We are also going to create a new user called ‘nagiosadmin’ with the password ‘nagios’ to be able to access the web panel. Then, we restart the service so all our changes go into effect.</p>

<figure class="highlight"><pre><code class="language-none" data-lang="none">htpasswd -b -c /etc/nagios3/htpasswd.users nagiosadmin nagios
service nagios3 restart</code></pre></figure>

<h1 id="monitoring-services-and-computers">Monitoring services and computers.</h1>

<p>Services exist inside of devices, logically speaking. We are going to install the monitoring agent in nagiosHost, and the process is exactly the same to monitor the other two devices on our network: servidorLamp and escritorioUsuario.</p>

<h2 id="installing-the-monitoring-agent">Installing the monitoring agent.</h2>

<figure class="highlight"><pre><code class="language-none" data-lang="none">DEBIAN_FRONTEND=noninteractive sudo apt-get install -y --force-yes build-essential nagios-nrpe-server nagios-plugins</code></pre></figure>

<p>We enable remote custom commands.</p>

<figure class="highlight"><pre><code class="language-none" data-lang="none">sudo sed -i "s/.*dont_blame_nrpe.*/dont_blame_nrpe = 1/" /etc/nagios/nrpe.cfg</code></pre></figure>

<p>And we whitelist the server.</p>

<figure class="highlight"><pre><code class="language-none" data-lang="none">sudo sed -i "s/.*allowed_hosts.*/allowed_hosts = 127.0.0.1 192.168.100.1/" /etc/nagios/nrpe.cfg</code></pre></figure>

<h2 id="adding-devices-to-the-monitoring-list">Adding devices to the monitoring list</h2>

<blockquote>
  <p><em>conf.d</em> is a folder that is consumed in its entirety to build the runtime configuration. We can split the settings however we see fit, following the criteria that fits our infrastructure best.</p>
</blockquote>

<p>These steps are to be perfomed on nagiosHost.</p>

<p><em>/etc/nagios3/conf.d/nodes.cfg</em> contains the list and addresses of the computers we are going to monitor. In our specific scenario, these would be its contents.</p>

<figure class="highlight"><pre><code class="language-none" data-lang="none">define host{
        use                     generic-host
        host_name               nagiosHost
        alias                   nagiosHost
        address                 127.0.0.1
}

define host{
        use                     generic-host        
        host_name               servidorLamp
        alias                   servidorLamp
        address                 192.168.100.2
}

define host{
        use                     generic-host            
        host_name               escritorioUsuario
        alias                   escritorioUsuario
        address                 192.168.100.3
}</code></pre></figure>

<p>Devices belong to groups, and monitoring policies can be applied to groups. We are going to store these definitions in <em>/etc/nagios3/conf.d/hostgroups_nagios2.cfg</em>.</p>

<figure class="highlight"><pre><code class="language-none" data-lang="none">define hostgroup {
        hostgroup_name  all
        alias           All Servers
        members         *
}

define hostgroup {
        hostgroup_name  debian-servers
        alias           Debian GNU/Linux Servers
        members         nagiosHost,escritorioUsuario
}

define hostgroup {
        hostgroup_name  http-servers
        alias           HTTP servers
        members         nagiosHost, servidorLamp
}

define hostgroup {
        hostgroup_name  ssh-servers
        alias           SSH servers
        members         nagiosHost
}

define hostgroup {
        hostgroup_name  mongo-servers
        alias           Mongo servers
        members         nagiosHost
}</code></pre></figure>

<h2 id="defining-services-to-monitor">Defining services to monitor</h2>

<p><em>/etc/nagios3/conf.d/services_nagios2.cfg</em> contains the definitions of the services we wish to monitor across groups of devices.</p>

<figure class="highlight"><pre><code class="language-none" data-lang="none">define service {
        hostgroup_name                  http-servers
        service_description             HTTP
        check_command                   check_http
        use                             generic-service
        notification_interval           0 ; set &gt; 0 if you want to be renotified
}

define service {
           hostgroup_name                  ssh-servers
           service_description             SSH
           check_command                   check_ssh
           use                             generic-service
           notification_interval           0 ; set &gt; 0 if you want to be renotified
}</code></pre></figure>

<p><em>/etc/nagios3/conf.d/nagiosHost.cfg</em></p>

<p>This file will contain the services we wish to monitor on nagiosHost: number of currently logged-in users, number of processes running and cpu load over time.</p>

<figure class="highlight"><pre><code class="language-none" data-lang="none">define service{
        use                             generic-service         
        host_name                       nagiosHost
        service_description             Current Users
        check_command                   check_users!20!50
}

define service{
        use                             generic-service         
        host_name                       nagiosHost
        service_description             Total Processes
                check_command                   check_procs!250!400
}

define service{
        use                             generic-service         
        host_name                       nagiosHost
        service_description             Current Load
                check_command                   check_load!5.0!4.0!3.0!10.0!6.0!4.0
}</code></pre></figure>

<p><em>/etc/nagios3/conf.d/escritorioUsuario.cfg</em></p>

<p>Likewise for escritorioUsuario: this will contain the relevant definitions to check for zombie processes.</p>

<figure class="highlight"><pre><code class="language-none" data-lang="none">define service{
        use                             generic-service         ; Name of service template to use
        host_name                       escritorioUsuario
        service_description             Zombie processes
                check_command           check_host_for_zombies
}</code></pre></figure>

<p>Since this is a custom check, we need to explicitly define it.</p>

<h2 id="adding-custom-service-checks">Adding custom service checks.</h2>

<p>Custom service checks are defined in two parts: A mandatory definition in the Nagios server, and an optional second definition in the monitored device.</p>

<p>In the Nagios server, we have to define the custom command name that will be run through on the server itself.</p>

<p>In the monitored device, the definition of the custom command we are going to run <em>inside</em> the monitorized device itself.</p>

<blockquote>
  <p>If we need to gather information about the state of the monitored device that can only be collected by running code <em>on the device</em>, then the secondary definition becomes necessary.</p>
</blockquote>

<p>For example, in our scenario we are going to check for zombie processes and if a MongoDB server is available. To gather information about the list of processes on the monitored machine, we have to run code on the machine itself. To ascertain whether a MongoDB server is up and accepting connections, we can do that from the outside by trying to connect to the MongoDB server <em>like any other client would</em>.</p>

<h3 id="checking-for-zombie-processes">Checking for zombie processes.</h3>

<h4 id="nagios-server">Nagios server</h4>

<p><em>/etc/nagios3/commands.cfg</em></p>

<figure class="highlight"><pre><code class="language-none" data-lang="none">define command {
    command_name    check_host_for_zombies
    command_line $USER1$/check_nrpe -H $HOSTADDRESS$ -c check_zombies
}</code></pre></figure>

<h4 id="monitored-device">Monitored device.</h4>

<p><em>/etc/nagios/nrpe_local.cfg</em></p>

<figure class="highlight"><pre><code class="language-none" data-lang="none">command[check_zombies]=/usr/lib/nagios/plugins/check_procs -w 0 -s Z+</code></pre></figure>

<h2 id="installing-additional-plugins-to-monitor-other-services">Installing additional plugins to monitor other services.</h2>

<p>To be able to monitor the state of the MongoDB database on nagiosHost, we are going to install <a href="https://github.com/mzupan/nagios-plugin-mongodb">nagios-plugin-mongodb</a>. The process is very similar to adding a custom check: the only explicit difference is that we don’t have a <em>check_mongodb</em> command already available in the PATH, thus we have to install it first.</p>

<h3 id="installing-nagios-plugin-mongodb">Installing nagios-plugin-mongodb</h3>

<p>Since the plugin is coded in Python, the install process is very simple. We are going to clone the repository on the Nagios server, install the requirements and then the python MongoDB connector.</p>

<figure class="highlight"><pre><code class="language-none" data-lang="none">cd /usr/lib/nagios/plugins
git clone git://github.com/mzupan/nagios-plugin-mongodb.git
pip install requirements
python -m pip install pymongo</code></pre></figure>

<p>We add the relevant service definition to the configuration. Since we may add additional MongoDB servers in the future, it makes sense to define it as a service that applies to a group of hosts.</p>

<p><em>/etc/nagios3/conf.d/services_nagios2.cfg</em></p>

<figure class="highlight"><pre><code class="language-none" data-lang="none">define service {
    use                 generic-service
    hostgroup_name          mongo-servers
    service_description     Mongo Connect Check
    check_command           check_mongodb!connect!27017!2!4
    contact_groups admins
}</code></pre></figure>

<p><em>commands.cfg</em></p>

<figure class="highlight"><pre><code class="language-none" data-lang="none">define command {
    command_name    check_mongodb
    command_line $USER1$/nagios-plugin-mongodb/check_mongodb.py -H $HOSTADDRESS$ -A $ARG1$ -P $ARG2$ -W $ARG3$ -C $ARG4$
}</code></pre></figure>

<p>The syntax of <em>check_mongodb.py</em> is explained in the <a href="https://github.com/mzupan/nagios-plugin-mongodb">documentation</a>, and each plugin we install may have a different syntax.</p>

<h2 id="setting-up-email-notifications">Setting up email notifications</h2>

<p>Nagios has the ability to send notifications emails to contact groups, which <em>obviously</em> contain contacts. Let’s create a contact called <em>root</em> that will belong to the contact group <em>admins</em>.</p>

<p><em>/etc/nagios3/conf.d/contacts_nagios2.cfg</em> will contain the list of contacts. It also contains the name of the commands used to send the notifications, which we’ll define later.</p>

<figure class="highlight"><pre><code class="language-none" data-lang="none">define contact{
        contact_name                    root
        alias                           Root
        service_notification_period     24x7
        host_notification_period        24x7
        service_notification_options    w,u,c,r,f
        host_notification_options       d,r,f
        service_notification_commands   notify-service-by-email
        host_notification_commands      notify-host-by-email
        email                           correo@servidor.com
}</code></pre></figure>

<p>And <em>/etc/nagios3/conf.d/contact_groups_nagios2.cfg</em> will contain the list of groups, along with their memberships.</p>

<figure class="highlight"><pre><code class="language-none" data-lang="none">define contactgroup {
        contactgroup_name       admins
        alias                   Level 7 Administrators
        members                 root
        }</code></pre></figure>

<p>Now, we need to add to each service the groups that we’d like to be notified in case of issues using the <em>contact_groups</em> variable. For the SSH service, it would look like this.</p>

<figure class="highlight"><pre><code class="language-none" data-lang="none">define service {
           hostgroup_name                  ssh-servers
           service_description             SSH
           check_command                   check_ssh
           use                             generic-service
           notification_interval           0 ; set &gt; 0 if you want to be renotified
           contact_groups admins
}</code></pre></figure>

<h3 id="customizing-the-email-contents-and-the-sending-methods">Customizing the email contents and the sending methods.</h3>

<p>In this post we will use _sendemail, to be able to send the emails through the use of GMail’s SMTP servers.</p>

<figure class="highlight"><pre><code class="language-none" data-lang="none">sudo apt-get install sendemail</code></pre></figure>

<p>We have to adapt the email-sending syntax on <em>commands.cfg</em>.</p>

<figure class="highlight"><pre><code class="language-none" data-lang="none">define command{
	command_name	notify-host-by-email
        command_line /usr/bin/printf "%b" "***** Nagios *****\n\nNotification Type: $NOTIFICATIONTYPE$\nHost: $HOSTNAME$\nState: $HOSTSTATE$\nAddress: $HOSTADDRESS$\nInfo: $HOSTOUTPUT$\n\nDate/Time: $LONGDATETIME$n" | /usr/bin/sendEmail -xu $USER4$ -xp $USER5$ -t $CONTACTEMAIL$ -f $CONTACTEMAIL$ -o tls=auto -s smtp.gmail.com  -u "** $NOTIFICATIONTYPE$ Host Alert: $HOSTNAME$ is $HOSTSTATE$ **" -m "***** Nagios *****\n\nNotification Type: $NOTIFICATIONTYPE$\nHost: $HOSTNAME$\nState: $HOSTSTATE$\nAddress: $HOSTADDRESS$\nInfo: $HOSTOUTPUT$\n\nDate/Time: $LONGDATETIME$\n" 
}

define command{
	command_name	notify-service-by-email
        command_line /usr/bin/printf "%b" "***** Nagios *****\n\nNotification Type: $NOTIFICATIONTYPE$\n\nService: $SERVICEDESC$\nHost: $HOSTALIAS$\nAddress: $HOSTADDRESS$\nState: $SERVICESTATE$\n\nDate/Time: $LONGDATETIME$\n\nAdditional Info:\n\n$SERVICEOUTPUT$" | /usr/bin/sendEmail -s smtp.gmail.com -xu $USER4$ -xp $USER5$ -t $CONTACTEMAIL$ -f $CONTACTEMAIL$ -u "** $NOTIFICATIONTYPE$ Service Alert: $HOSTALIAS$/$SERVICEDESC$ is $SERVICESTATE$ **" -m "***** Nagios *****\n\nNotification Type: $NOTIFICATIONTYPE$\n\nService: $SERVICEDESC$\nHost: $HOSTALIAS$\nAddress: $HOSTADDRESS$\nState: $SERVICESTATE$\n\nDate/Time: $LONGDATETIME$\n\nAdditional Info:\n\n$SERVICEOUTPUT$" 
}</code></pre></figure>

<blockquote>
  <p>You could further customize the command line to include other channels of communications. We could add SMS notifications through Twilio or messages through Slack, for example.</p>
</blockquote>

<p>Variables $USER4 and $USER5 will contain our GMail username and password, used to authenticate against the SMTP server.</p>

<p><em>/etc/nagios3/resource.cfg</em></p>

<figure class="highlight"><pre><code class="language-none" data-lang="none">$USER4$=username
$USER5$=password</code></pre></figure>

<blockquote>
  <p>WARNING: These credentials are stored in plaintext. Besides using proper file permissions, it is recommended we use service credentials generated explicitly and uniquely for Nagios. In GMail’s case, we can <a href="https://www.google.com/landing/2step/">enable 2-Factor authentication</a> and <a href="https://support.google.com/accounts/answer/185833">generate an app password</a>.</p>
</blockquote>

<h1 id="at-a-glance-overview-of-our-devices-and-services">At-a-glance overview of our devices and services.</h1>

<p>We can get a bird’s-eye view of our infrastructure through the use of the map view in the web interface.</p>

<p><img src="/assets/images/2017-08-18-Nagios/nagios_map.png" alt="Infrastructure map" /></p>

<p>If we click on any of the devices, we get a quick view of the services’ health.</p>

<p><img src="/assets/images/2017-08-18-Nagios/nagios_machine_detail_view.png" alt="Nagios device details" /></p>

<h1 id="testing-notifications">Testing notifications.</h1>

<h2 id="device-offline">Device offline.</h2>

<p>What happens if escritorioUsuario is offline? The expected behaviour is that Nagios will retry the connection a number of times, and then notify us that we have a problem if the device is still not responding.</p>

<p><img src="/assets/images/2017-08-18-Nagios/nagios_map_machine_offline_soft.png" alt="Device offline, map view." /></p>

<p><img src="/assets/images/2017-08-18-Nagios/nagios_details_machine_offline_soft.png" alt="Device offline, detail view." /></p>

<p>After a number of retries, Nagios marks the device as <em>officially offline</em> and proceeds to send an email notification.</p>

<p><img src="/assets/images/2017-08-18-Nagios/nagios_details_machine_offline_hard.png" alt="Device is definitively offline, detail view." /></p>

<p><img src="/assets/images/2017-08-18-Nagios/nagios_email_machine_offline_hard.png" alt="Email notification." /></p>

<p>After the machines comes back online, Nagios detects that the problem has been solved and notifies us.</p>

<p><img src="/assets/images/2017-08-18-Nagios/nagios_email_machine_back_online.png" alt="Device is back online, email notification." /></p>

<h2 id="zombie-process">Zombie process.</h2>

<p>To generate a zombie process, we execute the following line on the terminal of escritorioUsuario.</p>

<figure class="highlight"><pre><code class="language-none" data-lang="none">sleep 1 &amp; exec /bin/sleep 600</code></pre></figure>

<p><img src="/assets/images/2017-08-18-Nagios/nagios_zombie_process.png" alt="Zombie process detected." /></p>

<h2 id="mongodb-server-availability">MongoDB server availability.</h2>

<p>If we were to stop the MongoDB service to simulate a failure state, we can see that Nagios detects that new connections are not being established and sends an email notification about the matter.
<img src="/assets/images/2017-08-18-Nagios/nagios_mongodb.png" alt="MongoDB is refusing new connectionshg." /></p>

<h1 id="closing-thoughts">Closing thoughts.</h1>

<p>It is of vital importance that we are aware of issues in our infrastructure <em>before</em> the customers are.</p>

<p>Nagios allows us to condense down all the information about the state of our deployment into an easily <em>glanceable</em> dashboard, and the time investment required to set it up is worth the peace of mind of knowing our infrastructure is healthy and if that were to change we would be the first ones to know.</p>

	  </div>

		
		<ul class="tag_box list-unstyled list-inline">
		  <li><i class="fa fa-folder-open"></i></li>
		  
		  
			 
				<li><a href="/categories.html#nagios-ref">
					nagios <span>(1)</span>
					
				</a></li>
			
		  
		</ul>
		  

		
		<ul class="list-inline">
		  <li><i class="fa fa-tags"></i></li>
		  
		  
			 
				<li>
					<a href="/tags.html#monitoring-ref">
					monitoring <span>(1)</span>
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#nagios-ref">
					nagios <span>(1)</span>
					
					</a>
				</li>
			
		  
		  
		</ul>
		  

		<hr>

		<div>
      <section class="share col-sm-6">
        <h4 class="section-title">Share Post</h4>
        <a class="btn btn-default btn-sm twitter" href="http://twitter.com/share?text=Monitoring our infrastructure with Nagios."
           onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
          <i class="fa fa-twitter fa-lg"></i>
          Twitter
        </a>
        <a class="btn btn-default btn-sm facebook" href="https://www.facebook.com/sharer/sharer.php"
           onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
          <i class="fa fa-facebook fa-lg"></i>
          Facebook
        </a>
        <a class="btn btn-default btn-sm gplus"
           onclick="window.open('https://plus.google.com/share?url='+window.location.href, 'google-plus-share', 'width=490,height=530');return false;">
          <i class="fa fa-google-plus fa-lg"></i>
          Google+
        </a>
      </section>

<!-- Shows author's bio at the end of the post. 
      <section class="col-sm-6 author">
        <img src="//www.gravatar.com/avatar/da3470a132e93bfe23072dccad7e2956" class="img-rounded author-image" />
        <h4 class="section-title author-name">Josué Álvarez Moreno</h4>
        <p class="author-bio">System Administrator.</p>
      </section>
    </div>
-->
    <div class="clearfix"></div>

		<ul class="pager">
		  
		  <li class="previous"><a href="/terraform/2017/08/11/Terraform-101.html" title="Terraform 101">&larr; Previous</a></li>
		  
		  
			<li class="next disabled"><a>Next &rarr;</a>
		  
		</ul>

		<hr>
	</div>
	
	<div class="col-sm-2 sidebar-2">
	
	</div>
</article>
<div class="clearfix"></div>




	</div>

	<script type="text/javascript" src="/assets/resources/jquery/jquery.min.js"></script>
	<script type="text/javascript" src="/assets/resources/bootstrap/js/bootstrap.min.js"></script>
	<script type="text/javascript" src="/assets/js/app.js"></script>
</body>
</html>



<!-- Asynchronous Google Analytics snippet -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-104442288-1', 'auto');
  ga('send', 'pageview');
</script>

