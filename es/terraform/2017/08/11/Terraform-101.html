<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title></title>
	
	<meta name="author" content="Josué Álvarez Moreno">

	<!-- Enable responsive viewport -->
	<meta name="viewport" content="width=device-width, initial-scale=1.0">

	<!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
	<!--[if lt IE 9]>
	<script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
	<![endif]-->

	<!-- Le styles -->
	<link href="/assets/resources/bootstrap/css/bootstrap.min.css" rel="stylesheet">
	<link href="/assets/resources/font-awesome/css/font-awesome.min.css" rel="stylesheet">
	<link href="/assets/resources/syntax/syntax.css" rel="stylesheet">
	<link href="/assets/css/style.css" rel="stylesheet">

	<!-- Le fav and touch icons -->
	<!-- Update these with your own images
	<link rel="shortcut icon" href="images/favicon.ico">
	<link rel="apple-touch-icon" href="images/apple-touch-icon.png">
	<link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
	<link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
	-->

</head>

<body>
	<nav class="navbar navbar-default visible-xs" role="navigation">
		<!-- Brand and toggle get grouped for better mobile display -->
		<div class="navbar-header">
			<button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
				<span class="sr-only">Toggle navigation</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			
			<a type="button" class="navbar-toggle nav-link" href="http://github.com/j-alvarez-moreno">
				<i class="fa fa-github"></i>
			</a>
			
			
			<a type="button" class="navbar-toggle nav-link" href="mailto:blog@josuealvarezmoreno.com">
				<i class="fa fa-envelope"></i>
			</a>
			
			
			<a type="button" class="navbar-toggle nav-link" href="https://linkedin.com/in/josué-álvarez-moreno-b88896144">
				<i class="fa fa-linkedin fa-lg"></i>
			</a>
			
			<a type="button" class="navbar-toggle nav-link"  data-toggle="collapse" data-target="#language-picker">
				<i class="fa fa-globe"></i>
				<span class="sr-only">Language selection.</span>
			</a>
			<a class="navbar-brand" href="/es/">
				<img src="//www.gravatar.com/avatar/da3470a132e93bfe23072dccad7e2956?s=35" class="img-circle" />
				
			</a>
		</div>
		<div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
			<ul class="nav navbar-nav">
				<li class="active"><a href="/es/">Home</a></li>
				<li><a href="/es/categories.html">Categories</a></li>
				<li><a href="/es/tags.html">Tags</a></li>
			</ul>
		</div><!-- /.navbar-collapse -->
		<div class="collapse navbar-collapse" id="language-picker">
			<ul class="nav navbar-nav">
				
					<li><a 
							style="font-weight: bold; font-size: 20px; color: #ffcb6a"
						 href=" /es/terraform/2017/08/11/Terraform-101.html ">Español</a></li>
	  			
					<li><a 
							style="font-size: 16px; color: grey"
						 href=" /terraform/2017/08/11/Terraform-101.html ">English</a></li>
	  			
			</ul>
		</div>
	</nav>

	<!-- nav-menu-dropdown -->
	<div class="btn-group hidden-xs" id="nav-menu">
		<button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
			<i class="fa fa-bars"></i>
		</button>
		<ul class="dropdown-menu" role="menu">
			<li><a href="/es/"><i class="fa fa-home"></i>Home</a></li>
			<li><a href="/es/categories.html"><i class="fa fa-folder"></i>Categories</a></li>
			<li><a href="/es/tags.html"><i class="fa fa-tags"></i>Tags</a></li>
			<li class="divider"></li>
			<li><a href="#"><i class="fa fa-arrow-up"></i>Top of Page</a></li>
		</ul>
	</div>

	<div class="col-sm-3 sidebar hidden-xs" style="">
		<!-- sidebar.html -->
<header class="sidebar-header" role="banner">
	<a href="/es/">
		<img src="//www.gravatar.com/avatar/da3470a132e93bfe23072dccad7e2956?s=150" class="img-circle" />
	</a>
	<h3 class="title">
        <a href="/es/"></a>
    </h3>
</header>


<div id="bio" class="text-center">
	
</div>


<div id="contact-list" class="text-center">
	<ul class="list-unstyled list-inline">
		
		<li>
			<a class="btn btn-default btn-sm" href="https://github.com/j-alvarez-moreno">
				<i class="fa fa-github-alt fa-lg"></i>
			</a>
		</li>
		
		
		
		<li>
			<a class="btn btn-default btn-sm" href="mailto:blog@josuealvarezmoreno.com">
				<i class="fa fa-envelope fa-lg"></i>
			</a>
		</li>
		
		<li>
			<a class="btn btn-default btn-sm" href="https://linkedin.com/in/josué-álvarez-moreno-b88896144">
				<i class="fa fa-linkedin fa-lg"></i>
			</a>
		</li>
	</ul>
	<br><br><br><br>
	<div id="language-switcher">
  		
			<a 
					style="font-weight: bold; font-size: 20px; color: #ffcb6a"
				 href=" /es/terraform/2017/08/11/Terraform-101.html ">Español</a>
			 | 
  		
			<a 
					style="font-size: 16px; color: white"
				 href=" /terraform/2017/08/11/Terraform-101.html ">English</a>
			
  		
  	</div>
</div>
<!-- sidebar.html end -->

	</div>

	<div class="col-sm-9 col-sm-offset-3">
		<div class="page-header">
  <h1>Primeros pasos con Terraform </h1>
</div>
	
<article>

	<div class="col-sm-10">
	 <span class="post-date">
	   
	   August 
	   11th,
	   
	   2017
	 </span>
	  <div class="article_body">
	  <p>En este post exploraremos la herramienta Terraform, sus ventajas y desventajas; y desplegaremos una instancia de prueba en Amazon AWS.</p>

<ul id="markdown-toc">
  <li><a href="#qué-es-terraform" id="markdown-toc-qué-es-terraform">Qué es Terraform.</a></li>
  <li><a href="#funcionamiento-básico-de-terraform" id="markdown-toc-funcionamiento-básico-de-terraform">Funcionamiento básico de Terraform.</a></li>
  <li><a href="#ventajas-e-inconvenientes-de-terraform" id="markdown-toc-ventajas-e-inconvenientes-de-terraform">Ventajas e inconvenientes de Terraform.</a>    <ul>
      <li><a href="#pros" id="markdown-toc-pros">Pros</a></li>
      <li><a href="#inconvenientes-y-detalles-a-tener-en-cuenta" id="markdown-toc-inconvenientes-y-detalles-a-tener-en-cuenta">Inconvenientes y detalles a tener en cuenta.</a></li>
    </ul>
  </li>
  <li><a href="#instalación" id="markdown-toc-instalación">Instalación.</a></li>
  <li><a href="#primeros-pasos-desplegar-una-instancia-en-amazon-aws" id="markdown-toc-primeros-pasos-desplegar-una-instancia-en-amazon-aws">Primeros pasos: Desplegar una instancia en Amazon AWS.</a></li>
  <li><a href="#provisionamiento-simple-de-instancias" id="markdown-toc-provisionamiento-simple-de-instancias">Provisionamiento simple de instancias.</a></li>
</ul>

<h1 id="qué-es-terraform">Qué es Terraform.</h1>

<p>Desarrollado por Hashicorp, creadores de Vagrant y Packer, Terraform es software que nos permite definir nuestra infraestructura como código. Terraform procesa nuestro código, lo compara con el estado del proveedor de servicios especificado y construye un plan de ejecución para que el estado de la infraestructura desplegada sea el definido en el código.</p>

<p>Explicado de forma práctica: podemos añadir nuevas instancias o modificar instancias y recursos en nuestro código (claves ssh, conectividad de red, reglas de firewall…) y aplicarlos a la infraestructura remota sin preocuparnos del <em>cómo</em>.</p>

<p>Terraform tiene soporte para los principales proveedores de infraestructura local o en la nube como Amazon AWS, Microsoft Azure, Openstack, VMware vSphere y Digital Ocean. La lista completa se encuentra, en inglés, en la <a href="https://www.terraform.io/docs/providers/index.html">web de Terraform</a>.</p>

<!--more-->

<h1 id="funcionamiento-básico-de-terraform">Funcionamiento básico de Terraform.</h1>
<p>Terraform tiene principalmente cuatro comandos: <strong>refresh</strong>, <strong>plan</strong>, <strong>apply</strong> y <strong>destroy</strong>. Refresh refresca la caché actual del estado de la infraestructura definida en el código, plan muestra los cambios que se realizarían comparando el estado del código con el del proveedor, y apply aplica los cambios. Destroy es evidente, y pide confirmación antes de borrar nada.</p>

<blockquote>
  <p>Apply no pide confirmación. Cualquier diferencia entre el estado remoto y el definido localmente será solucionada de forma irreversible. Es conveniente visualizar el plan antes de ejecutar cambios.</p>
</blockquote>

<h1 id="ventajas-e-inconvenientes-de-terraform">Ventajas e inconvenientes de Terraform.</h1>

<h2 id="pros">Pros</h2>

<ul>
  <li>Infraestructura como código (IaC): Podremos versionar/revertir/redimensionar nuestra infraestructura de forma no destructiva. Esto nos permite, por ejemplo: mantener un historial <em>reversible</em> de la configuración de la red incluyendo reglas de cortafuegos y VLANs, desplegar un centro de datos 100% idéntico al principal de forma automatizada en una situación de emergencia o recrear nuestra infraestructura de forma parcial o total en un entorno de desarrollo o pruebas.</li>
  <li>Velocidad: Terraform es muy, muy rápido. Si el proveedor de infraestructura lo soporta, Terraform es capaz de generar los recursos especificados de forma paralela. En la práctica, esto posibilita que el tiempo de despliegue de 1 máquina sea el mismo que el requerido para 10.</li>
  <li>Agnóstico: A diferencia de Heat o CloudFormation, Terraform es capaz de trabajar de forma simultánea con todos sus diferentes proveedores de infraestructura.</li>
  <li>Flexibilidad: Terraform procesa todos los ficheros <em>.tf</em> del directorio y los combina en memoria para generar el plan de ejecución, lo que nos permite separar los recursos de manera lógica y manejable.</li>
</ul>

<h2 id="inconvenientes-y-detalles-a-tener-en-cuenta">Inconvenientes y detalles a tener en cuenta.</h2>

<ul>
  <li>Depende enteramente de la API de cada proveedor: Aunque la herramienta intenta mitigar posibles fallos mediante reintentos, timeouts y el uso de una caché local que contiene el estado de la infraestructura, está a merced de la fiabilidad de la API. Una respuesta inconsistente por parte del proveedor puede ocasionar que Terraform no reconozca un recurso concreto, y dado que no forma parte del plan declarado en los ficheros, dicho recurso por defecto será eliminado.
    <ul>
      <li>Podemos mitigar esta circunstancia especificando una solución alternativa al conflicto <a href="https://www.terraform.io/docs/configuration/resources.html#lifecycle">mediante la directiva lifecycle</a>.</li>
    </ul>
  </li>
  <li>Terraform almacena el estado de los recursos en el fichero <em>terraform.state</em>, y esta es el punto de referencia a la hora de generar planes de ejecución. Si se modifica la infraestructura remota desde fuera de Terraform, el comportamiento de la herramienta puede no ser el deseado.</li>
  <li>La sintáxis declarativa de los ficheros no es agnóstica respecto al proveedor utilizado. Por tanto, debemos mantener diferentes versiones de nuestra infraestructura según dónde vayamos a desplegarla.</li>
</ul>

<h1 id="instalación">Instalación.</h1>
<p>Aunque nosotros utilizaremos Terraform en Linux, también está disponible para otras plataformas como Windows o OSX.</p>

<p>Descargaremos la versión de Terraform deseada <a href="https://www.terraform.io/downloads.html">desde su página web</a>. Terraform no necesita instalación, basta con descomprimir el archivo.</p>

<h1 id="primeros-pasos-desplegar-una-instancia-en-amazon-aws">Primeros pasos: Desplegar una instancia en Amazon AWS.</h1>
<p>Para que Terraform pueda acceder a los recursos del proveedor que hayamos elegido, necesitaremos claves API. En el caso de Amazon AWS, podemos obtenerlas <a href="https://console.aws.amazon.com/iam/home#security_credential">en la consola de AWS</a>.</p>

<p><img src="/assets/images/aws-credentials-console.png" alt="Gestión de credenciales de Amazon AWS" /></p>

<p>A continuación vamos a generar un fichero <em>ejemplo.tf</em> que contendrá la definición de una máquina Ubuntu 16.04 en una instancia t2.micro, con la configuración mínima necesaria para poder conectarnos por SSH.</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1"># Definimos las claves de acceso a la API de AWS</span>
<span class="n">provider</span> <span class="s2">"aws"</span> <span class="p">{</span>
  <span class="n">access_key</span> <span class="o">=</span> <span class="s2">"ESCRIBE_TU_CLAVE"</span>
  <span class="n">secret_key</span> <span class="o">=</span> <span class="s2">"ESCRIBE_TU_CLAVE"</span>
  <span class="n">region</span>     <span class="o">=</span> <span class="s2">"us-east-1"</span>
<span class="p">}</span>

<span class="c1"># Detalles de la instancia</span>

<span class="n">resource</span> <span class="s2">"aws_instance"</span> <span class="s2">"ejemplo"</span> <span class="p">{</span>
  <span class="n">ami</span>           <span class="o">=</span> <span class="s2">"ami-2757f631"</span> <span class="c1"># Esta es la ami de Ubuntu Server 16.04</span>
  <span class="n">instance_type</span> <span class="o">=</span> <span class="s2">"t2.micro"</span>
  <span class="n">subnet_id</span>     <span class="o">=</span> <span class="s2">"${aws_subnet.default.id}"</span>
<span class="p">}</span>
<span class="c1"># Clave pública SSH que usaremos para conectarnos a la instancia.</span>
<span class="c1"># Evidentemente, esta clave de ejemplo no es una clave válida.</span>
<span class="n">resource</span> <span class="s2">"aws_key_pair"</span> <span class="s2">"ssh-keys"</span> <span class="p">{</span>
  <span class="n">key_name</span>   <span class="o">=</span> <span class="s2">"terraform"</span>
  <span class="n">public_key</span> <span class="o">=</span> <span class="s2">"ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDFOuj5NcQMwA4v5E/qcbsN0NsyR0BmdWU9VeIr9BFlE8/R4jnUMS6Sa9tf52omzJyRlr6M64GykzHmSnp8Aro7CK9dM+8PuktmJF+/EEuDsj/5ynyK+JQ9VlrbspJBXJhUs84LQK+1DngxVuyj1dxFSTvFVVafl0uuYmJOgzhS5MkFa16G/P9PiV44tEsq8wjnVbNBpKmom06f85uPaqegM45gbzGmE7PEjxkDaw/7DD3UatBYJ1oA8JaCUCfr4LishPbuT+lWEIDROnhGOhzz7GlnSgOxyhDnhteVFQzMBQLIGKzwG1uNL+1OaPJ5j4jXplShe7kmfMrmC6hOtdmp josue@pruebaTerraform"</span>
<span class="p">}</span>
<span class="c1"># Creamos una red virtual privada para la instancia</span>
<span class="n">resource</span> <span class="s2">"aws_vpc"</span> <span class="s2">"default"</span> <span class="p">{</span>
  <span class="n">cidr_block</span> <span class="o">=</span> <span class="s2">"10.0.0.0/16"</span>
<span class="p">}</span>

<span class="c1"># Un gateway para que la máquina tenga acceso a internet</span>
<span class="n">resource</span> <span class="s2">"aws_internet_gateway"</span> <span class="s2">"default"</span> <span class="p">{</span>
  <span class="n">vpc_id</span> <span class="o">=</span> <span class="s2">"${aws_vpc.default.id}"</span>
<span class="p">}</span>
<span class="c1"># Damos acceso a internet a la vpc</span>
<span class="n">resource</span> <span class="s2">"aws_route"</span> <span class="s2">"internet_access"</span> <span class="p">{</span>
  <span class="n">route_table_id</span>         <span class="o">=</span> <span class="s2">"${aws_vpc.default.main_route_table_id}"</span>
  <span class="n">destination_cidr_block</span> <span class="o">=</span> <span class="s2">"0.0.0.0/0"</span>
  <span class="n">gateway_id</span>             <span class="o">=</span> <span class="s2">"${aws_internet_gateway.default.id}"</span>
<span class="p">}</span>

<span class="c1"># Una subnet para nuestra máquina</span>
<span class="n">resource</span> <span class="s2">"aws_subnet"</span> <span class="s2">"default"</span> <span class="p">{</span>
  <span class="n">vpc_id</span>                  <span class="o">=</span> <span class="s2">"${aws_vpc.default.id}"</span>
  <span class="n">cidr_block</span>              <span class="o">=</span> <span class="s2">"10.0.1.0/24"</span>
  <span class="n">map_public_ip_on_launch</span> <span class="o">=</span> <span class="kp">true</span>
<span class="p">}</span>

<span class="c1"># Creamos un grupo de seguridad para poder abrir puertos en la vpc</span>
<span class="n">resource</span> <span class="s2">"aws_security_group"</span> <span class="s2">"elb"</span> <span class="p">{</span>
  <span class="nb">name</span>        <span class="o">=</span> <span class="s2">"terraform_example_elb"</span>
  <span class="n">description</span> <span class="o">=</span> <span class="s2">"Grupo de seguridad de ejemplo"</span>
  <span class="n">vpc_id</span>      <span class="o">=</span> <span class="s2">"${aws_vpc.default.id}"</span>

  <span class="c1"># Abrimos el puerto 80 desde y hacia todas partes</span>
  <span class="n">ingress</span> <span class="p">{</span>
    <span class="n">from_port</span>   <span class="o">=</span> <span class="mi">80</span>
    <span class="n">to_port</span>     <span class="o">=</span> <span class="mi">80</span>
    <span class="n">protocol</span>    <span class="o">=</span> <span class="s2">"tcp"</span>
    <span class="n">cidr_blocks</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"0.0.0.0/0"</span><span class="p">]</span>
  <span class="p">}</span>

  <span class="c1"># “-1” significa TCP y UDP</span>
  <span class="n">egress</span> <span class="p">{</span>
    <span class="n">from_port</span>   <span class="o">=</span> <span class="mi">0</span>
    <span class="n">to_port</span>     <span class="o">=</span> <span class="mi">0</span>
    <span class="n">protocol</span>    <span class="o">=</span> <span class="s2">"-1"</span>
    <span class="n">cidr_blocks</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"0.0.0.0/0"</span><span class="p">]</span>
  <span class="p">}</span>
  <span class="c1"># Permitimos acceso SSH desde cualquier IP. Sin esto, no podremos conectarnos tras desplegar la máquina.</span>
  <span class="n">ingress</span> <span class="p">{</span>
    <span class="n">from_port</span>   <span class="o">=</span> <span class="mi">22</span>
    <span class="n">to_port</span>     <span class="o">=</span> <span class="mi">22</span>
    <span class="n">protocol</span>    <span class="o">=</span> <span class="s2">"tcp"</span>
    <span class="n">cidr_blocks</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"0.0.0.0/0"</span><span class="p">]</span>
  <span class="p">}</span>
  </code></pre></figure>

<p>Si inspeccionamos el plan generado por Terraform, observamos que va a crear la instancia especificada.</p>

<figure class="highlight"><pre><code class="language-none" data-lang="none">$ terraform plan
+ aws_instance.example
    ami:                          "ami-2757f631"
    associate_public_ip_address:  "&lt;computed&gt;"
    availability_zone:            "&lt;computed&gt;"
    ebs_block_device.#:           "&lt;computed&gt;"
    ephemeral_block_device.#:     "&lt;computed&gt;"
    instance_state:               "&lt;computed&gt;"
    instance_type:                "t2.micro"
    ipv6_address_count:           "&lt;computed&gt;"
    ipv6_addresses.#:             "&lt;computed&gt;"
    key_name:                     "&lt;computed&gt;"
    network_interface.#:          "&lt;computed&gt;"
    network_interface_id:         "&lt;computed&gt;"
    placement_group:              "&lt;computed&gt;"
    primary_network_interface_id: "&lt;computed&gt;"
    private_dns:                  "&lt;computed&gt;"
    private_ip:                   "&lt;computed&gt;"
    public_dns:                   "&lt;computed&gt;"
    public_ip:                    "&lt;computed&gt;"
    root_block_device.#:          "&lt;computed&gt;"
    security_groups.#:            "&lt;computed&gt;"
    source_dest_check:            "true"
    subnet_id:                    "&lt;computed&gt;"
    tenancy:                      "&lt;computed&gt;"
    volume_tags.%:                "&lt;computed&gt;"
    vpc_security_group_ids.#:     "&lt;computed&gt;"

Plan: 1 to add, 0 to change, 0 to destroy.</code></pre></figure>

<p>Nota: este plan sólo existe en memoria. Al realizar <em>terraform apply</em> Terraform volverá a refrescar y el plan generado puede ser diferente si las circunstancias son diferentes.</p>

<blockquote>
  <p>Nota: Es posible almacenar el plan con el switch <strong>-out</strong> y pasárselo a apply.</p>
</blockquote>

<p>Vamos a aplicar los cambios.</p>

<figure class="highlight"><pre><code class="language-none" data-lang="none">$ terraform apply
aws_instance.example: Creating...
  ami:                          "" =&gt; "ami-2757f631"
  associate_public_ip_address:  "" =&gt; "&lt;computed&gt;"
  availability_zone:            "" =&gt; "&lt;computed&gt;"
  ebs_block_device.#:           "" =&gt; "&lt;computed&gt;"
  ephemeral_block_device.#:     "" =&gt; "&lt;computed&gt;"
  instance_state:               "" =&gt; "&lt;computed&gt;"
  instance_type:                "" =&gt; "t2.micro"
  ipv6_address_count:           "" =&gt; "&lt;computed&gt;"
  ipv6_addresses.#:             "" =&gt; "&lt;computed&gt;"
  key_name:                     "" =&gt; "&lt;computed&gt;"
  network_interface.#:          "" =&gt; "&lt;computed&gt;"
  network_interface_id:         "" =&gt; "&lt;computed&gt;"
  placement_group:              "" =&gt; "&lt;computed&gt;"
  primary_network_interface_id: "" =&gt; "&lt;computed&gt;"
  private_dns:                  "" =&gt; "&lt;computed&gt;"
  private_ip:                   "" =&gt; "&lt;computed&gt;"
  public_dns:                   "" =&gt; "&lt;computed&gt;"
  public_ip:                    "" =&gt; "&lt;computed&gt;"
  root_block_device.#:          "" =&gt; "&lt;computed&gt;"
  security_groups.#:            "" =&gt; "&lt;computed&gt;"
  source_dest_check:            "" =&gt; "true"
  subnet_id:                    "" =&gt; "subnet-3fd11213"
  tenancy:                      "" =&gt; "&lt;computed&gt;"
  volume_tags.%:                "" =&gt; "&lt;computed&gt;"
  vpc_security_group_ids.#:     "" =&gt; "&lt;computed&gt;"
aws_instance.example: Still creating... (10s elapsed)
aws_instance.example: Still creating... (20s elapsed)
aws_instance.example: Creation complete (ID: i-02fbb95386573f5ec)

Apply complete! Resources: 1 added, 0 changed, 0 destroyed.</code></pre></figure>

<p>Ahora podemos comprobar el estado (cacheado) de nuestra infraestructura con <em>terraform show</em>. Entre otros datos, tenemos la IP pública de la instancia.</p>

<figure class="highlight"><pre><code class="language-none" data-lang="none">aws_instance.example:
  id = i-02fbb95386573f5ec
  ami = ami-2757f631
  associate_public_ip_address = true
  availability_zone = us-east-1a
  disable_api_termination = false
  ebs_block_device.# = 0
  ebs_optimized = false
  ephemeral_block_device.# = 0
  iam_instance_profile = 
  instance_state = running
  instance_type = t2.micro
  ipv6_address_count = 0
  ipv6_addresses.# = 0
  key_name = 
  monitoring = false
  network_interface.# = 0
  network_interface_id = eni-0aaf6ac3
  primary_network_interface_id = eni-0aaf6ac3
  private_dns = ip-10-0-0-149.ec2.internal
  private_ip = 10.0.0.149
  public_dns = ec2-107-21-158-184.compute-1.amazonaws.com
  public_ip = 107.21.158.184
  root_block_device.# = 1
  root_block_device.0.delete_on_termination = true
  root_block_device.0.iops = 100
  root_block_device.0.volume_size = 8
  root_block_device.0.volume_type = gp2
  security_groups.# = 0
  source_dest_check = true
  subnet_id = subnet-3fd11213
  tags.% = 0
  tenancy = default
  volume_tags.% = 0
  vpc_security_group_ids.# = 1
  vpc_security_group_ids.713989925 = sg-535d3d2d</code></pre></figure>

<p>Vamos a deshacernos de esta instancia de ejemplo con el comando destroy.</p>

<figure class="highlight"><pre><code class="language-none" data-lang="none">$ terraform destroy
Do you really want to destroy?
  Terraform will delete all your managed infrastructure.
  There is no undo. Only 'yes' will be accepted to confirm.

  Enter a value: yes

aws_instance.example: Refreshing state... (ID: i-02fbb95386573f5ec)
aws_instance.example: Destroying... (ID: i-02fbb95386573f5ec)
aws_instance.example: Still destroying... (ID: i-02fbb95386573f5ec, 10s elapsed)
aws_instance.example: Still destroying... (ID: i-02fbb95386573f5ec, 20s elapsed)
aws_instance.example: Still destroying... (ID: i-02fbb95386573f5ec, 30s elapsed)
aws_instance.example: Still destroying... (ID: i-02fbb95386573f5ec, 41s elapsed)
aws_instance.example: Still destroying... (ID: i-02fbb95386573f5ec, 51s elapsed)
aws_instance.example: Still destroying... (ID: i-02fbb95386573f5ec, 1m1s elapsed)
aws_instance.example: Still destroying... (ID: i-02fbb95386573f5ec, 1m11s elapsed)
aws_instance.example: Destruction complete</code></pre></figure>

<h1 id="provisionamiento-simple-de-instancias">Provisionamiento simple de instancias.</h1>
<p>Tras crear la instancia, podemos copiar ficheros y directorios a la misma. Así mismo, con la directiva <em>remote-exec</em> podemos indicarle la ruta de un script local y Terraform lo copiará a la instancia y lo ejecutará.</p>

<p>Vamos a probarlo con un sencillo “Hola”. Creamos un fichero llamado <em>bootstrap.sh</em> que contendrá el comando de prueba.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c">#!/bin/bash</span>
<span class="nb">echo</span> <span class="s1">'hello’ &gt; /tmp/output.txt</span></code></pre></figure>

<p>Modificamos la definición de la instancia para añadir el provisionador, y la clave SSH que debe usar para conectarse.</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">resource</span> <span class="s2">"aws_instance"</span> <span class="s2">"instancia1"</span> <span class="p">{</span>
  <span class="n">ami</span>           <span class="o">=</span> <span class="s2">"ami-b374d5a5"</span>
  <span class="n">instance_type</span> <span class="o">=</span> <span class="s2">"t2.micro"</span>
  <span class="n">key_name</span> <span class="o">=</span> <span class="s2">"terraform"</span>

  <span class="n">provisioner</span> <span class="s2">"remote-exec"</span> <span class="p">{</span>
    <span class="n">scripts</span> <span class="o">=</span> <span class="p">[</span>
      <span class="s2">"bootstrap.sh"</span>
    <span class="p">]</span>
    <span class="n">connection</span> <span class="p">{</span>
      <span class="n">type</span>     <span class="o">=</span> <span class="s2">"ssh"</span>
      <span class="n">user</span>     <span class="o">=</span> <span class="s2">"ubuntu"</span>
      <span class="n">private_key</span> <span class="o">=</span> <span class="s2">"${file("</span><span class="o">~</span><span class="sr">/.ssh/</span><span class="n">clave</span><span class="o">-</span><span class="n">terraform</span><span class="o">-</span><span class="n">blog</span><span class="s2">")}"</span>
    <span class="p">}</span>  
  <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>Tras aplicar el plan, observamos que Terraform se conecta a la instancia y ejecuta <em>bootstrap.sh</em>:</p>

<figure class="highlight"><pre><code class="language-none" data-lang="none">aws_instance.instancia1 (remote-exec): Connecting to remote host via SSH...
aws_instance.instancia1 (remote-exec):   Host: 54.90.2.13
aws_instance.instancia1 (remote-exec):   User: ubuntu
aws_instance.instancia1 (remote-exec):   Password: false
aws_instance.instancia1 (remote-exec):   Private key: true
aws_instance.instancia1 (remote-exec):   SSH Agent: true
aws_instance.instancia1 (remote-exec): Connected!
aws_instance.instancia1: Creation complete (ID: i-03cbd14db6ba0a896)</code></pre></figure>

<p>Y comprobamos que funciona.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="gp">$ </span>ssh -i ~/.ssh/terraform-proyecto ubuntu@54.234.144.181 <span class="s2">"cat /tmp/output.txt’”
Hola</span></code></pre></figure>

<p>En un futuro post exploraremos como utilizar esta funcionalidad para provisionar máquinas de forma completamente automática.</p>

	  </div>

		
		<ul class="tag_box list-unstyled list-inline">
		  <li><i class="fa fa-folder-open"></i></li>
		  
		  
			 
				<li><a href="/categories.html#terraform-ref">
					terraform <span>(1)</span>
					
				</a></li>
			
		  
		</ul>
		  

		
		<ul class="list-inline">
		  <li><i class="fa fa-tags"></i></li>
		  
		  
			 
				<li>
					<a href="/tags.html#terraform-ref">
					terraform <span>(1)</span>
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#primeros pasos-ref">
					primeros pasos <span>(1)</span>
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#cloud-ref">
					cloud <span>(1)</span>
					
					</a>
				</li>
			
		  
		  
		</ul>
		  

		<hr>

		<div>
      <section class="share col-sm-6">
        <h4 class="section-title">Share Post</h4>
        <a class="btn btn-default btn-sm twitter" href="http://twitter.com/share?text=Primeros pasos con Terraform"
           onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
          <i class="fa fa-twitter fa-lg"></i>
          Twitter
        </a>
        <a class="btn btn-default btn-sm facebook" href="https://www.facebook.com/sharer/sharer.php"
           onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
          <i class="fa fa-facebook fa-lg"></i>
          Facebook
        </a>
        <a class="btn btn-default btn-sm gplus"
           onclick="window.open('https://plus.google.com/share?url='+window.location.href, 'google-plus-share', 'width=490,height=530');return false;">
          <i class="fa fa-google-plus fa-lg"></i>
          Google+
        </a>
      </section>

<!-- Shows author's bio at the end of the post. 
      <section class="col-sm-6 author">
        <img src="//www.gravatar.com/avatar/da3470a132e93bfe23072dccad7e2956" class="img-rounded author-image" />
        <h4 class="section-title author-name">Josué Álvarez Moreno</h4>
        <p class="author-bio">Administrador de Sistemas.</p>
      </section>
    </div>
-->
    <div class="clearfix"></div>

		<ul class="pager">
		  
		  <li class="previous"><a href="/es/placeholder/2017/08/01/hello-world.html" title="Hello World!">&larr; Previous</a></li>
		  
		  
		  <li class="next"><a href="/es/nagios/2017/08/18/Nagios.html" title="Monitorización de sistemas y redes con Nagios">Next &rarr;</a></li>
		  
		</ul>

		<hr>
	</div>
	
	<div class="col-sm-2 sidebar-2">
	
	</div>
</article>
<div class="clearfix"></div>




	</div>

	<script type="text/javascript" src="/assets/resources/jquery/jquery.min.js"></script>
	<script type="text/javascript" src="/assets/resources/bootstrap/js/bootstrap.min.js"></script>
	<script type="text/javascript" src="/assets/js/app.js"></script>
</body>
</html>



<!-- Asynchronous Google Analytics snippet -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-104442288-1', 'auto');
  ga('send', 'pageview');
</script>

