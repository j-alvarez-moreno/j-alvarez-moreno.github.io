---
layout: post
title: Monitorización de sistemas y redes con Nagios
categories: [nagios]
tags: [monitoring, nagios]
fullview: false
comments: false
published: false
lang: en

---

In this post we will learn how to monitor computers and services with Nagios. This will allow us to receive timely and actionable alerts about issues in our infrastructure.

* TOC
{:toc}

What is Nagios.
=================
Nagios is an application that monitors computers, services, networks and infrastructure. It sends alerts in case of trouble, and it sends notifications when the issue is resolved.

Unlike other commercial alternatives like SolarWinds, Nagios is both free and Open Source and [it also offers the option of purchasing a support plan](https://support.nagios.com/support-plans/).

Nagios: How it works.
===========================

Nagios can obtain information about the monitored resources in two different ways:

- Using the Nagios Agent: After deploying the Agent to the computers you want to monitor, these agents collect the information and perform the checks by themselves before sending them to the Nagios server.
    -The main advantage of this method is the flexbility it offers, since we can define custom checks and write code to monitor any resource we can think of. The disadvantage would be that we have to push the definition of these custom checks to the clients.

- _Agentless_ : The Nagios server uses the facilities provided by the device that is being monitored (for example, VMI or SNMP).
    - The main advantage of this mode is that it reduces the complexity of our deployment, and it allows us to centralize all the configuration in the Nagios server. The disadvantage would be that it does not allow for custom checks, so if the device does not provide a facility for monitoring a resource we can't monitor it this way.

Nagios is able to use both modes at the same time, combining the results from agent checks and from agentless checks.
<!--more-->
Monitored service states, and transition flow between states.
-------------------------------------------------------------------------------------------

The state of a resource is determined through two components:

    - The state of the service or resource: OK, WARNING, UP, DOWN...
    - The _type_ of state the resource is in: _soft_ or _hard_.

To prevent false positives caused by temporary circumstances, Nagios will perform the check a number of times before considering a problem to be "happening". This number of retries is defined by the _max_check_attempts_ variable, and if the limit is reached Nagios will change the issue from _soft_ to _hard_. This also works in reverse, before marking an issue as _solved_ the check is repeated this same number of times.

El estado de un servicio o recurso se determina a través de dos componentes:
	
	- El estado del servicio o recurso: OK, WARNING, UP, DOWN...
	- El _tipo_ de estado en el que se encuentra el servicio.

Unless we specify otherwise, notifications are only set when a resource is _hard down_.

We can write our own handler for these events to perfom custom actions depending on the resource state. For example, if the web server is _soft down_ and the check has been retried 3 times already, we can trigger the deployment of a secondary instance of the web server and add it to the load balancer in anticipation of the main web server going down.

[The states are described in much more detail in the manual](https://assets.nagios.com/downloads/nagioscore/docs/nagioscore/3/en/statetypes.html).

### A resource is "flapping". What does "flapping" mean?

When a resource is rapidly and repeatedly transitioning between _OK_ and a state that means an issue is happening, the resource is tagged as _flapping_. This could indicate a deeper issue, or be caused by perfectly normal conditions, for example we know for sure that the database becomes unresponsive at a certain time of the day because of heavy load, and we know it does not affect regular operations.

In any case, flapping would generate many notifications about the same issue. In order to mitigate this situation, we should increase _max_check_attempts_ to a value that allows these false positives to fall under the threshold and be careful to not increase too much that issues go unreported.

Nagios contains logic that tries to address flapping, but given the nature of the problem it might not be enough for any specific environment.

Description of the scenario we will work with in this post.
===========================================================

We have three virtual machines in the same network, all three using Debian 8 (Jessie).

- nagios-host: 192.168.100.1, will function as the Nagios server. It will also host a MongoDB instance, and an SSH server.
- servidor-lamp: 192.168.100.2, will have a LAMP stack installed.
- escritorio-usuario: 192.168.100.3, will be a desktop for the end-user to use.

This scenario can be deployed automatically through the use of this [Vagrantfile]({{ site.url }}/assets/vagrantfiles/2017-08-18-Nagios/Vagrantfile.zip), including all services and configuration.

Installing Nagios.
======================
_nrpe-server_ es un agente instalado en las máquinas cliente que se encarga de comunicar con el host Nagios para informar de estado y ejecución de comandos de forma remota. Estos comando pueden ser definidos de forma manual por el administrador, aunque un conjunto de comandos de uso frecuente se encuentra pre-empaquetado en nagios-plugins. Más adelante veremos cómo instalar plugins adicionales para monitorizar MongoDB, y cómo definir nuestros propios comandos (usaremos como ejemplo comprobar si existen procesos zombie).

Para instalar estos dos componentes y el núcleo de Nagios en nagios-host, podemos hacerlo desde los repositorios.

{% highlight none %}
sudo DEBIAN_FRONTEND=noninteractive apt-get -y install nagios-plugins nagios3 nagios-nrpe-plugin
{% endhighlight %}

Para poder forzar chequeos sobre los servicios y hosts de forma manual, debemos cambiar el valor de la directiva check_external_commands a 1 en el archivo _/etc/nagios3/nagios.cfg_.
También debemos cambiar el usuario y modo de dos directorios para permitir la ejecución de estos, ya que Nagios ejecuta estos chequeos a través de un archivo temporal que debe poder ser ejecutable por el usuario del servidor web. Dado que el archivo se recrea en cada ejecución, vamos a fijar los permisos a nivel del directorio.

{% highlight none %}
dpkg-statoverride --update --add nagios www-data 2710 /var/lib/nagios3/rw
sudo dpkg-statoverride --update --add nagios nagios 751 /var/lib/nagios3
{% endhighlight %}

Para habilitar el acceso web, creamos un usuario llamado ‘nagiosadmin’ con contraseña ‘nagios’ y reiniciamos el servicio:

{% highlight none %}
htpasswd -b -c /etc/nagios3/htpasswd.users nagiosadmin nagios
service nagios3 restart
{% endhighlight %}

Monitorización de servicios y equipos.
======================================

Los servicios están asociados a equipos. Para poder añadirlos debemos instalar el agente de monitorización en él. Realizaré este proceso en nagiosHost, siendo idéntico en servidorLamp y en escritorioUsuario.

Configuración común a los tres hosts
------------------------------------

### Instalación del agente de monitorización

{% highlight none %}
DEBIAN_FRONTEND=noninteractive sudo apt-get install -y --force-yes build-essential nagios-nrpe-server nagios-plugins
{% endhighlight %}

Habilitamos la ejecución de comandos de forma remota.

{% highlight none %}
sudo sed -i "s/.*dont_blame_nrpe.*/dont_blame_nrpe = 1/" /etc/nagios/nrpe.cfg
{% endhighlight %}

Y damos permiso al servidor Nagios, en este caso nosotros mismos, para hacerlo.

{% highlight none %}
sudo sed -i "s/.*allowed_hosts.*/allowed_hosts = 127.0.0.1 192.168.100.1/" /etc/nagios/nrpe.cfg
{% endhighlight %}

Configuración específica
------------------------

> El directorio _conf.d_ es procesado en su totalidad al construir la configuración final. Podemos almacenar la configuración en archivos cfg con diferentes nombres que respondan a la organización logica de nuestra infraestructura, sin tener que seguir el patrón establecido en este post.

### nagiosHost

_/etc/nagios3/conf.d/nodes.cfg_

Aquí añadimos los equipos a monitorizar. En nuestro caso, el archivo tendrá el siguiente contenido.

{% highlight none %}
define host{
        use                     generic-host
        host_name               nagiosHost
        alias                   nagiosHost
        address                 127.0.0.1
}

define host{
        use                     generic-host        
        host_name               servidorLamp
        alias                   servidorLamp
        address                 192.168.100.2
}

define host{
        use                     generic-host            
        host_name               escritorioUsuario
        alias                   escritorioUsuario
        address                 192.168.100.3
}
{% endhighlight %}

_/etc/nagios3/conf.d/hostgroups_nagios2.cfg_

Aquí se describen los grupos de equipos, de forma que los ajustes de monitorización se apliquen a todos los elementos de una misma categoría.

{% highlight none %}
define hostgroup {
        hostgroup_name  all
        alias           All Servers
        members         *
}

define hostgroup {
        hostgroup_name  debian-servers
        alias           Debian GNU/Linux Servers
        members         nagiosHost,escritorioUsuario
}

define hostgroup {
        hostgroup_name  http-servers
        alias           HTTP servers
        members         nagiosHost, servidorLamp
}

define hostgroup {
        hostgroup_name  ssh-servers
        alias           SSH servers
        members         nagiosHost
}

define hostgroup {
        hostgroup_name  mongo-servers
        alias           Mongo servers
        members         nagiosHost
}

{% endhighlight %}

_/etc/nagios3/conf.d/contacts_nagios2.cfg_

Aquí debemos definir nuestra dirección de contacto, para las notificaciones de email.

{% highlight none %}
define contact{
        contact_name                    root
        alias                           Root
        service_notification_period     24x7
        host_notification_period        24x7
        service_notification_options    w,u,c,r,f
        host_notification_options       d,r,f
        service_notification_commands   notify-service-by-email
        host_notification_commands      notify-host-by-email
        email                           correo@servidor.com
}
{% endhighlight %}

_/etc/nagios3/conf.d/services_nagios2.cfg_

Este archivo contendrá los servicios a monitorizar. Por defecto no tiene entradas para MongoDB, así que las añadimos. También añadimos la línea “contact_groups admins” a las categorías de las cuales queremos recibir notificaciones de email.

{% highlight none %}
define service {
        hostgroup_name                  http-servers
        service_description             HTTP
        check_command                   check_http
        use                             generic-service
        notification_interval           0 ; set > 0 if you want to be renotified
}

define service {
           hostgroup_name                  ssh-servers
           service_description             SSH
           check_command                   check_ssh
           use                             generic-service
           notification_interval           0 ; set > 0 if you want to be renotified
           contact_groups admins
}

define service {
use                 generic-service
hostgroup_name          mongo-servers
service_description     Mongo Connect Check
check_command           check_mongodb!connect!27017!2!4
contact_groups admins
}

{% endhighlight %}

_/etc/nagios3/conf.d/nagiosHost.cfg_

Aquí incluiremos definiciones de servicios para monitorizar los usuarios que se loguean en la máquina, el número de procesos y la carga de cpu.

{% highlight none %}
define service{
        use                             generic-service         
        host_name                       nagiosHost
        service_description             Current Users
        check_command                   check_users!20!50
}

define service{
        use                             generic-service         
        host_name                       nagiosHost
        service_description             Total Processes
                check_command                   check_procs!250!400
}

define service{
        use                             generic-service         
        host_name                       nagiosHost
        service_description             Current Load
                check_command                   check_load!5.0!4.0!3.0!10.0!6.0!4.0
}
{% endhighlight %}

_/etc/nagios3/conf.d/escritorioUsuario.cfg_

Aquí incorporamos definiciones de espacio libre en disco y de procesos zombie.

{% highlight none %}
define service{
        use                             generic-service         ; Name of service template to use
        host_name                       escritorioUsuario
        service_description             Disk Space
        check_command                   check_all_disks!20%!10%
}

define service{
        use                             generic-service         ; Name of service template to use
        host_name                       escritorioUsuario
        service_description             Zombie processes
                check_command           check_host_for_zombies
}
{% endhighlight %}

_/etc/nagios3/commands.cfg_

Aquí se encuentran la definición de check_zombies, para que sean ejecutadas por el agente nrpe. Añadimos el siguiente contenido al archivo de configuración:

{% highlight none %}
define command {
    command_name    check_host_for_zombies
    command_line $USER1$/check_nrpe -H $HOSTADDRESS$ -c check_zombies
}
{% endhighlight %}

### servidorLamp

No se necesita configuración adicional.

### escritorioUsuario

Añadimos la definición del comando para comprobar la existencia de procesos zombie.

_/etc/nagios/nrpe_local.cfg_

{% highlight none %}
command[check_zombies]=/usr/lib/nagios/plugins/check_procs -w 0 -s Z+
{% endhighlight%}

## Monitorización de MongoDB

Para comprobar el estado del servicio de MongoDB en nagiosHost, vamos a utilizar [nagios-plugin-mongodb]https://github.com/mzupan/nagios-plugin-mongodb).

En nagiosHost, clonamos el repositorio git del plugin e instalamos sus requisitos.

{% highlight none %}
cd /usr/lib/nagios/plugins
git clone git://github.com/mzupan/nagios-plugin-mongodb.git
pip install requirements
python -m pip install pymongo
{% endhighlight%}

Definimos el servicio en /etc/nagios3/conf.d/services_nagios2.cfg de manera que se aplique a todos los servidores del grupo mongo-servers.

{% highlight none %}
define service {
    use                 generic-service
    hostgroup_name          mongo-servers
    service_description     Mongo Connect Check
    check_command           check_mongodb!connect!27017!2!4
    contact_groups admins
}
{% endhighlight%}

Y definimos el comando check_mongodb en commands.cfg.

{% highlight none %}
define command {
    command_name    check_mongodb
    command_line $USER1$/nagios-plugin-mongodb/check_mongodb.py -H $HOSTADDRESS$ -A $ARG1$ -P $ARG2$ -W $ARG3$ -C $ARG4$
}
{% endhighlight%}


### Configuración del envio de alertas por correo
En mi caso particular, voy a utilizar _sendemail_ para enviar correo a través del servidor SMTP de GMail. Lo instalamos en nagiosHost con la siguiente línea

{% highlight none %}
sudo apt-get install sendemail
{% endhighlight%}

Modificamos el comando de envío de correo en commands.cfg para que se adecúe a la sintaxis del comando sendemail.

{% highlight none %}
# 'notify-host-by-email' command definition
define command{
	command_name	notify-host-by-email
        command_line /usr/bin/printf "%b" "***** Nagios *****nnNotification Type: $NOTIFICATIONTYPE$nHost: $HOSTNAME$nState: $HOSTSTATE$nAddress: $HOSTADDRESS$nInfo: $HOSTOUTPUT$nnDate/Time: $LONGDATETIME$n" | /usr/bin/sendEmail -xu $USER4$ -xp $USER5$ -t $CONTACTEMAIL$ -f $CONTACTEMAIL$ -o tls=auto -s smtp.gmail.com  -u "** $NOTIFICATIONTYPE$ Host Alert: $HOSTNAME$ is $HOSTSTATE$ **" -m "***** Nagios *****nnNotification Type: $NOTIFICATIONTYPE$nHost: $HOSTNAME$nState: $HOSTSTATE$nAddress: $HOSTADDRESS$nInfo: $HOSTOUTPUT$nnDate/Time: $LONGDATETIME$n" 
}

# 'notify-service-by-email' command definition
define command{
	command_name	notify-service-by-email
        command_line /usr/bin/printf "%b" "***** Nagios *****nnNotification Type: $NOTIFICATIONTYPE$nnService: $SERVICEDESC$nHost: $HOSTALIAS$nAddress: $HOSTADDRESS$nState: $SERVICESTATE$nnDate/Time: $LONGDATETIME$nnAdditional Info:nn$SERVICEOUTPUT$" | /usr/bin/sendEmail -s smtp.gmail.com -xu $USER4$ -xp $USER5$ -t $CONTACTEMAIL$ -f $CONTACTEMAIL$ -u "** $NOTIFICATIONTYPE$ Service Alert: $HOSTALIAS$/$SERVICEDESC$ is $SERVICESTATE$ **" -m "***** Nagios *****nnNotification Type: $NOTIFICATIONTYPE$nnService: $SERVICEDESC$nHost: $HOSTALIAS$nAddress: $HOSTADDRESS$nState: $SERVICESTATE$nnDate/Time: $LONGDATETIME$nnAdditional Info:nn$SERVICEOUTPUT$" 
}
{% endhighlight%}

Añadimos las definiciones de las variables $USER4 y $USER5, que corresponden respectivamente a nuestro usuario y contraseña de GMail, en el archivo /etc/nagios3/resource.cfg.

{% highlight none %}
$USER4$=usuario
$USER5$=contraseña
{% endhighlight%}

> Estos datos se almacenan en texto plano. Por seguridad, es conveniente generar credenciales propias para Nagios.
En el caso de GMail, esto puede hacerse activando [autenticación en dos pasos](https://www.google.com/landing/2step/) y [generando una contraseña de aplicación](https://support.google.com/accounts/answer/185833).

Comprobar el mapa de nuestros equipos y servicios.
==================================================

A través de la interfaz web, en la sección “Map” podemos ver una representación gráfica de nuestra infraestructura.

![Mapa de la infraestructura en Nagios]({{site.url}}/assets/images/2017-08-18-Nagios/nagios_map.png)

Si hacemos click en cualquiera de los equipos, podemos ver a simple vista su estado de salud.

![Detalles de un equipo específico en Nagios]({{site.url}}/assets/images/2017-08-18-Nagios/nagios_machine_detail_view.png)

Comprobación de funcionamiento y notificaciones.
================================================

Equipo fuera de línea.
----------------------

Vamos a simular un fallo apagando la máquina escritorioUsuario.

![Equipo fuera de linea, vista de mapa.]({{site.url}}/assets/images/2017-08-18-Nagios/nagios_map_machine_offline_soft.png)
![Equipo fuera de linea, vista de detalles.]({{site.url}}/assets/images/2017-08-18-Nagios/nagios_details_machine_offline_soft.png)

Pasado el número de reintentos especificado la máquina pasa a estar fuera de línea _oficialmente_ y se envía la notificación correspondiente.

![Equipo fuera de linea, vista de detalles.]({{site.url}}/assets/images/2017-08-18-Nagios/nagios_details_machine_offline_hard.png)
![Equipo fuera de linea, email notificación.]({{site.url}}/assets/images/2017-08-18-Nagios/nagios_email_machine_offline_hard.png)

Tras volver a encender la máquina, vemos que Nagios detecta que se ha resuelto el problema, y nos envía una notificación al respecto.

![Equipo vuelve a estar disponible, email de notificación.]({{site.url}}/assets/images/2017-08-18-Nagios/nagios_email_machine_back_online.png)

Proceso Zombie.
--------------

Generamos un proceso zombie usando la siguiente línea en la terminal de escritorioUsuario.

{% highlight none %}
sleep 1 & exec /bin/sleep 600
{% endhighlight %}

Y observamos que Nagios lo detecta, y nos envia el email correspondiente.

![Proceso zombie detectado.]({{site.url}}/assets/images/2017-08-18-Nagios/nagios_zombie_process.png)

Base de datos MongoDB fuera de línea.
-------------------------------------

Si detenemos el servicio de MongoDB, comprobamos que efectivamente falla el chequeo de Nagios y nos notifica adecuadamente.
![Servidor MongoDB fuera de línea.]({{site.url}}/assets/images/2017-08-18-Nagios/nagios_mongodb.png)
