---
layout: post
title: Monitorización de sistemas y redes con Nagios
categories: [nagios]
tags: [monitoring, nagios]
fullview: false
comments: false
published: true
lang: es

---

En este post aprenderemos a monitorizar nuestras máquinas y servicios con Nagios. Gracias a este software, recibiremos alertas detalladas y accionables sobre nuestra insfraestructura.

* TOC
{:toc}

Qué es Nagios.
=================
Nagios es software usado para monitorizar sistemas, servicios, redes e infraestructura. Envía alertas en caso de problemas, y notificaciones cuando el problema ha sido resuelto.

Al contrario que otras soluciones comerciales como SolarWinds, Nagios es _open source_ y gratis con la posibilidad [de contratar soporte comercial](https://support.nagios.com/support-plans/).

Conceptos básicos para trabajar con Nagios.
===========================

Nagios puede obtener información de los recursos a monitorizar de dos formas diferentes, siendo capaz de usar ambas a la vez:

- A través del agente de Nagios: Comprobaciones regulares iniciadas por los mismos clientes y enviadas al servidor, requiere instalación del agente en los equipos a monitorizar. La principal ventaja es la flexibilidad a la hora de desplegar addons o comprobaciones personalizadas.

- _Agentless_ ("sin agente"): El servidor Nagios utiliza tecnologías como WMI y SNMP para realizar comprobaciones sobre los recursos monitorizados. Su principal ventaja es la reducción en complejidad del despliegue, y la centralización de la configuración en el servidor Nagios.

<!--more-->

Posibles estado y flujo de transición entre estados de un servicio o recurso monitorizados.
-------------------------------------------------------------------------------------------

El estado de un servicio o recurso se determina a través de dos componentes:
	
	- El estado del servicio o recurso: OK, WARNING, UP, DOWN...
	- El _tipo_ de estado en el que se encuentra el servicio.

Hay dos tipos de estado en Nagios: _soft_ y _hard_. Para prevenir falsas alarmas provocadas por problemas transitorios, Nagios realiza un número de reintentos antes de considerar que un problema es "real". El número de reintentos se define en la variable _max_check_attempts_, y cuando se supera el límite especificado el problema pasa de _soft_ a _hard_. De la misma forma, para considerar un problema como _solucionado_ se efectúa el mismo número de comprobaciones antes de transicionar el estado de _hard_ a solucionado.

Salvo que hayamos especificado lo contrario, las notificaciones sólo se envían cuando el servicio entra en estado _hard down_.

Nagios nos permite escribir nuestro propio script que determine la acción a tomar según el estado del recurso monitorizado. Por ejemplo, si un servidor web está en estado _soft down_ y se ha reintentado 4 veces la comprobación, podríamos iniciar el despliegue de otro servidor web anticipándonos a la posible caída del servicio.

Los estados se describen en mucho más detalle [en la web del programa (en inglés)](https://assets.nagios.com/downloads/nagioscore/docs/nagioscore/3/en/statetypes.html).

### Qué significa que un servicio o recurso está "flapping".

_Flapping_ es una palabra inglesa que describe el aleteo frenético de un pájaro cuando intenta mantener el vuelo en condiciones adversas.

Volviendo a Nagios: cuando un servicio cambia rápidamente entre disponible y algún estado de error, se considera que el servicio está _flapping_. Esto puede deberse a circunstancias transitorias perfectamente normales (por ejemplo, alta carga de CPU durante operaciones específicas en la base de datos que no afectan al funcionamiento de la aplicación), y puede generar una lluvia de notificaciones sobre un falso problema. 

La manera de mitigar el problema es observar el comportamiento habitual del servicio o recurso y configurar _max_check_attempts_ a un valor suficientemente alto para que estas circunstancias de funcionamiento _correctas_ no generen falsas alertas. Dado que cada entorno y condiciones de uso son diferentes, los ajustes por defecto de detección de _flapping_ de Nagios pueden ser inadecuados para nuestra infraestructura.


Escenario sobre el cual trabajaremos en este post.
==================================================

Tendremos 3 máquinas virtuales en la misma red, con el sistema operativo Debian en su versión 8 (Jessie).

- nagios-host: 192.168.100.1, actuará de host para Nagios. Tendrá instalado un servidor SSH y una base de datos MongoDB.
- servidor-lamp: 192.168.100.2, tendrá instalado una stack LAMP.
- escritorio-usuario: 192.168.100.3, es un cliente Debian estándar.

Este escenario está recogido en este [Vagrantfile]({{ site.url }}/assets/vagrantfiles/2017-08-18-Nagios/es/Vagrantfile.zip), incluyendo el despliegue de los servicios y la configuración del servidor Nagios y los clientes. 

Instalación de Nagios.
======================
_nrpe-server_ es un agente instalado en las máquinas cliente que se encarga de comunicar con el host Nagios para informar de estado y ejecución de comandos de forma remota. Estos comando pueden ser definidos de forma manual por el administrador, aunque un conjunto de comandos de uso frecuente se encuentra pre-empaquetado en nagios-plugins. Más adelante veremos cómo instalar plugins adicionales para monitorizar MongoDB, y cómo definir nuestros propios comandos (usaremos como ejemplo comprobar si existen procesos zombie).

Para instalar estos dos componentes y el núcleo de Nagios en nagios-host, podemos hacerlo desde los repositorios.

{% highlight none %}
sudo DEBIAN_FRONTEND=noninteractive apt-get -y install nagios-plugins nagios3 nagios-nrpe-plugin
{% endhighlight %}

Para poder forzar chequeos sobre los servicios y hosts de forma manual, debemos cambiar el valor de la directiva check_external_commands a 1 en el archivo _/etc/nagios3/nagios.cfg_.
También debemos cambiar el usuario y modo de dos directorios para permitir la ejecución de estos, ya que Nagios ejecuta estos chequeos a través de un archivo temporal que debe poder ser ejecutable por el usuario del servidor web. Dado que el archivo se recrea en cada ejecución, vamos a fijar los permisos a nivel del directorio.

{% highlight none %}
dpkg-statoverride --update --add nagios www-data 2710 /var/lib/nagios3/rw
sudo dpkg-statoverride --update --add nagios nagios 751 /var/lib/nagios3
{% endhighlight %}

Para habilitar el acceso web, creamos un usuario llamado ‘nagiosadmin’ con contraseña ‘nagios’ y reiniciamos el servicio:

{% highlight none %}
htpasswd -b -c /etc/nagios3/htpasswd.users nagiosadmin nagios
service nagios3 restart
{% endhighlight %}

Monitorización de servicios y equipos.
======================================

Los servicios están asociados a equipos. Para poder añadirlos debemos instalar el agente de monitorización en él. Realizaré este proceso en nagiosHost, siendo idéntico en servidorLamp y en escritorioUsuario.

Configuración común a los tres hosts
------------------------------------

### Instalación del agente de monitorización

{% highlight none %}
DEBIAN_FRONTEND=noninteractive sudo apt-get install -y --force-yes build-essential nagios-nrpe-server nagios-plugins
{% endhighlight %}

Habilitamos la ejecución de comandos de forma remota.

{% highlight none %}
sudo sed -i "s/.*dont_blame_nrpe.*/dont_blame_nrpe = 1/" /etc/nagios/nrpe.cfg
{% endhighlight %}

Y damos permiso al servidor Nagios, en este caso nosotros mismos, para hacerlo.

{% highlight none %}
sudo sed -i "s/.*allowed_hosts.*/allowed_hosts = 127.0.0.1 192.168.100.1/" /etc/nagios/nrpe.cfg
{% endhighlight %}

Configuración específica
------------------------

> El directorio _conf.d_ es procesado en su totalidad al construir la configuración final. Podemos almacenar la configuración en archivos cfg con diferentes nombres que respondan a la organización logica de nuestra infraestructura, sin tener que seguir el patrón establecido en este post.

### nagiosHost

_/etc/nagios3/conf.d/nodes.cfg_

Aquí añadimos los equipos a monitorizar. En nuestro caso, el archivo tendrá el siguiente contenido.

{% highlight none %}
define host{
        use                     generic-host
        host_name               nagiosHost
        alias                   nagiosHost
        address                 127.0.0.1
}

define host{
        use                     generic-host        
        host_name               servidorLamp
        alias                   servidorLamp
        address                 192.168.100.2
}

define host{
        use                     generic-host            
        host_name               escritorioUsuario
        alias                   escritorioUsuario
        address                 192.168.100.3
}
{% endhighlight %}

_/etc/nagios3/conf.d/hostgroups_nagios2.cfg_

Aquí se describen los grupos de equipos, de forma que los ajustes de monitorización se apliquen a todos los elementos de una misma categoría.

{% highlight none %}
define hostgroup {
        hostgroup_name  all
        alias           All Servers
        members         *
}

define hostgroup {
        hostgroup_name  debian-servers
        alias           Debian GNU/Linux Servers
        members         nagiosHost,escritorioUsuario
}

define hostgroup {
        hostgroup_name  http-servers
        alias           HTTP servers
        members         nagiosHost, servidorLamp
}

define hostgroup {
        hostgroup_name  ssh-servers
        alias           SSH servers
        members         nagiosHost
}

define hostgroup {
        hostgroup_name  mongo-servers
        alias           Mongo servers
        members         nagiosHost
}

{% endhighlight %}

_/etc/nagios3/conf.d/contacts_nagios2.cfg_

Aquí debemos definir nuestra dirección de contacto, para las notificaciones de email.

{% highlight none %}
define contact{
        contact_name                    root
        alias                           Root
        service_notification_period     24x7
        host_notification_period        24x7
        service_notification_options    w,u,c,r,f
        host_notification_options       d,r,f
        service_notification_commands   notify-service-by-email
        host_notification_commands      notify-host-by-email
        email                           correo@servidor.com
}
{% endhighlight %}

_/etc/nagios3/conf.d/services_nagios2.cfg_

Este archivo contendrá los servicios a monitorizar. Por defecto no tiene entradas para MongoDB, así que las añadimos. También añadimos la línea “contact_groups admins” a las categorías de las cuales queremos recibir notificaciones de email.

{% highlight none %}
define service {
        hostgroup_name                  http-servers
        service_description             HTTP
        check_command                   check_http
        use                             generic-service
        notification_interval           0 ; set > 0 if you want to be renotified
}

define service {
           hostgroup_name                  ssh-servers
           service_description             SSH
           check_command                   check_ssh
           use                             generic-service
           notification_interval           0 ; set > 0 if you want to be renotified
           contact_groups admins
}

define service {
use                 generic-service
hostgroup_name          mongo-servers
service_description     Mongo Connect Check
check_command           check_mongodb!connect!27017!2!4
contact_groups admins
}

{% endhighlight %}

_/etc/nagios3/conf.d/nagiosHost.cfg_

Aquí incluiremos definiciones de servicios para monitorizar los usuarios que se loguean en la máquina, el número de procesos y la carga de cpu.

{% highlight none %}
define service{
        use                             generic-service         
        host_name                       nagiosHost
        service_description             Current Users
        check_command                   check_users!20!50
}

define service{
        use                             generic-service         
        host_name                       nagiosHost
        service_description             Total Processes
                check_command                   check_procs!250!400
}

define service{
        use                             generic-service         
        host_name                       nagiosHost
        service_description             Current Load
                check_command                   check_load!5.0!4.0!3.0!10.0!6.0!4.0
}
{% endhighlight %}

_/etc/nagios3/conf.d/escritorioUsuario.cfg_

Aquí incorporamos definiciones de espacio libre en disco y de procesos zombie.

{% highlight none %}
define service{
        use                             generic-service         ; Name of service template to use
        host_name                       escritorioUsuario
        service_description             Disk Space
        check_command                   check_all_disks!20%!10%
}

define service{
        use                             generic-service         ; Name of service template to use
        host_name                       escritorioUsuario
        service_description             Zombie processes
                check_command           check_host_for_zombies
}
{% endhighlight %}

_/etc/nagios3/commands.cfg_

Aquí se encuentran la definición de check_zombies, para que sean ejecutadas por el agente nrpe. Añadimos el siguiente contenido al archivo de configuración:

{% highlight none %}
define command {
    command_name    check_host_for_zombies
    command_line $USER1$/check_nrpe -H $HOSTADDRESS$ -c check_zombies
}
{% endhighlight %}

### servidorLamp

No se necesita configuración adicional.

### escritorioUsuario

Añadimos la definición del comando para comprobar la existencia de procesos zombie.

_/etc/nagios/nrpe_local.cfg_

{% highlight none %}
command[check_zombies]=/usr/lib/nagios/plugins/check_procs -w 0 -s Z+
{% endhighlight%}

## Monitorización de MongoDB

Para comprobar el estado del servicio de MongoDB en nagiosHost, vamos a utilizar [nagios-plugin-mongodb]https://github.com/mzupan/nagios-plugin-mongodb).

En nagiosHost, clonamos el repositorio git del plugin e instalamos sus requisitos.

{% highlight none %}
cd /usr/lib/nagios/plugins
git clone git://github.com/mzupan/nagios-plugin-mongodb.git
pip install requirements
python -m pip install pymongo
{% endhighlight%}

Definimos el servicio en /etc/nagios3/conf.d/services_nagios2.cfg de manera que se aplique a todos los servidores del grupo mongo-servers.

{% highlight none %}
define service {
    use                 generic-service
    hostgroup_name          mongo-servers
    service_description     Mongo Connect Check
    check_command           check_mongodb!connect!27017!2!4
    contact_groups admins
}
{% endhighlight%}

Y definimos el comando check_mongodb en commands.cfg.

{% highlight none %}
define command {
    command_name    check_mongodb
    command_line $USER1$/nagios-plugin-mongodb/check_mongodb.py -H $HOSTADDRESS$ -A $ARG1$ -P $ARG2$ -W $ARG3$ -C $ARG4$
}
{% endhighlight%}


### Configuración del envio de alertas por correo
En mi caso particular, voy a utilizar _sendemail_ para enviar correo a través del servidor SMTP de GMail. Lo instalamos en nagiosHost con la siguiente línea

{% highlight none %}
sudo apt-get install sendemail
{% endhighlight%}

Modificamos el comando de envío de correo en commands.cfg para que se adecúe a la sintaxis del comando sendemail.

{% highlight none %}
# 'notify-host-by-email' command definition
define command{
	command_name	notify-host-by-email
        command_line /usr/bin/printf "%b" "***** Nagios *****nnNotification Type: $NOTIFICATIONTYPE$nHost: $HOSTNAME$nState: $HOSTSTATE$nAddress: $HOSTADDRESS$nInfo: $HOSTOUTPUT$nnDate/Time: $LONGDATETIME$n" | /usr/bin/sendEmail -xu $USER4$ -xp $USER5$ -t $CONTACTEMAIL$ -f $CONTACTEMAIL$ -o tls=auto -s smtp.gmail.com  -u "** $NOTIFICATIONTYPE$ Host Alert: $HOSTNAME$ is $HOSTSTATE$ **" -m "***** Nagios *****nnNotification Type: $NOTIFICATIONTYPE$nHost: $HOSTNAME$nState: $HOSTSTATE$nAddress: $HOSTADDRESS$nInfo: $HOSTOUTPUT$nnDate/Time: $LONGDATETIME$n" 
}

# 'notify-service-by-email' command definition
define command{
	command_name	notify-service-by-email
        command_line /usr/bin/printf "%b" "***** Nagios *****nnNotification Type: $NOTIFICATIONTYPE$nnService: $SERVICEDESC$nHost: $HOSTALIAS$nAddress: $HOSTADDRESS$nState: $SERVICESTATE$nnDate/Time: $LONGDATETIME$nnAdditional Info:nn$SERVICEOUTPUT$" | /usr/bin/sendEmail -s smtp.gmail.com -xu $USER4$ -xp $USER5$ -t $CONTACTEMAIL$ -f $CONTACTEMAIL$ -u "** $NOTIFICATIONTYPE$ Service Alert: $HOSTALIAS$/$SERVICEDESC$ is $SERVICESTATE$ **" -m "***** Nagios *****nnNotification Type: $NOTIFICATIONTYPE$nnService: $SERVICEDESC$nHost: $HOSTALIAS$nAddress: $HOSTADDRESS$nState: $SERVICESTATE$nnDate/Time: $LONGDATETIME$nnAdditional Info:nn$SERVICEOUTPUT$" 
}
{% endhighlight%}

Añadimos las definiciones de las variables $USER4 y $USER5, que corresponden respectivamente a nuestro usuario y contraseña de GMail, en el archivo /etc/nagios3/resource.cfg.

{% highlight none %}
$USER4$=usuario
$USER5$=contraseña
{% endhighlight%}

> Estos datos se almacenan en texto plano. Por seguridad, es conveniente generar credenciales propias para Nagios.
En el caso de GMail, esto puede hacerse activando [autenticación en dos pasos](https://www.google.com/landing/2step/) y [generando una contraseña de aplicación](https://support.google.com/accounts/answer/185833).

Comprobar el mapa de nuestros equipos y servicios.
==================================================

A través de la interfaz web, en la sección “Map” podemos ver una representación gráfica de nuestra infraestructura.

![Mapa de la infraestructura en Nagios]({{site.url}}/assets/images/2017-08-18-Nagios/nagios_map.png)

Si hacemos click en cualquiera de los equipos, podemos ver a simple vista su estado de salud.

![Detalles de un equipo específico en Nagios]({{site.url}}/assets/images/2017-08-18-Nagios/nagios_machine_detail_view.png)

Comprobación de funcionamiento y notificaciones.
================================================

Equipo fuera de línea.
----------------------

Vamos a simular un fallo apagando la máquina escritorioUsuario.

![Equipo fuera de linea, vista de mapa.]({{site.url}}/assets/images/2017-08-18-Nagios/nagios_map_machine_offline_soft.png)
![Equipo fuera de linea, vista de detalles.]({{site.url}}/assets/images/2017-08-18-Nagios/nagios_details_machine_offline_soft.png)

Pasado el número de reintentos especificado la máquina pasa a estar fuera de línea _oficialmente_ y se envía la notificación correspondiente.

![Equipo fuera de linea, vista de detalles.]({{site.url}}/assets/images/2017-08-18-Nagios/nagios_details_machine_offline_hard.png)
![Equipo fuera de linea, email notificación.]({{site.url}}/assets/images/2017-08-18-Nagios/nagios_email_machine_offline_hard.png)

Tras volver a encender la máquina, vemos que Nagios detecta que se ha resuelto el problema, y nos envía una notificación al respecto.

![Equipo vuelve a estar disponible, email de notificación.]({{site.url}}/assets/images/2017-08-18-Nagios/nagios_email_machine_back_online.png)

Proceso Zombie.
--------------

Generamos un proceso zombie usando la siguiente línea en la terminal de escritorioUsuario.

{% highlight none %}
sleep 1 & exec /bin/sleep 600
{% endhighlight %}

Y observamos que Nagios lo detecta, y nos envia el email correspondiente.

![Proceso zombie detectado.]({{site.url}}/assets/images/2017-08-18-Nagios/nagios_zombie_process.png)

Base de datos MongoDB fuera de línea.
-------------------------------------

Si detenemos el servicio de MongoDB, comprobamos que efectivamente falla el chequeo de Nagios y nos notifica adecuadamente.
![Servidor MongoDB fuera de línea.]({{site.url}}/assets/images/2017-08-18-Nagios/nagios_mongodb.png)
